<!DOCTYPE html><html amp i-amphtml-layout i-amphtml-no-boilerplate transformed="self;v=1"><head><meta charset="utf-8"><style amp-runtime i-amphtml-version="012011070101001">html{overflow-x:hidden!important}html.i-amphtml-fie{height:100%!important;width:100%!important}html:not([amp4ads]),html:not([amp4ads]) body{height:auto!important}html:not([amp4ads]) body{margin:0!important}body{-webkit-text-size-adjust:100%;-moz-text-size-adjust:100%;-ms-text-size-adjust:100%;text-size-adjust:100%}html.i-amphtml-singledoc.i-amphtml-embedded{-ms-touch-action:pan-y;touch-action:pan-y}html.i-amphtml-fie>body,html.i-amphtml-singledoc>body{overflow:visible!important}html.i-amphtml-fie:not(.i-amphtml-inabox)>body,html.i-amphtml-singledoc:not(.i-amphtml-inabox)>body{position:relative!important}html.i-amphtml-webview>body{overflow-x:hidden!important;overflow-y:visible!important;min-height:100vh!important}html.i-amphtml-ios-embed-legacy>body{overflow-x:hidden!important;overflow-y:auto!important;position:absolute!important}html.i-amphtml-ios-embed{overflow-y:auto!important;position:static}#i-amphtml-wrapper{overflow-x:hidden!important;overflow-y:auto!important;position:absolute!important;top:0!important;left:0!important;right:0!important;bottom:0!important;margin:0!important;display:block!important}html.i-amphtml-ios-embed.i-amphtml-ios-overscroll,html.i-amphtml-ios-embed.i-amphtml-ios-overscroll>#i-amphtml-wrapper{-webkit-overflow-scrolling:touch!important}#i-amphtml-wrapper>body{position:relative!important;border-top:1px solid transparent!important}#i-amphtml-wrapper+body{visibility:visible}#i-amphtml-wrapper+body .i-amphtml-lightbox-element,#i-amphtml-wrapper+body[i-amphtml-lightbox]{visibility:hidden}#i-amphtml-wrapper+body[i-amphtml-lightbox] .i-amphtml-lightbox-element{visibility:visible}#i-amphtml-wrapper.i-amphtml-scroll-disabled,.i-amphtml-scroll-disabled{overflow-x:hidden!important;overflow-y:hidden!important}amp-instagram{padding:54px 0px 0px!important;background-color:#fff}amp-iframe iframe{box-sizing:border-box!important}[amp-access][amp-access-hide]{display:none}[subscriptions-dialog],body:not(.i-amphtml-subs-ready) [subscriptions-action],body:not(.i-amphtml-subs-ready) [subscriptions-section]{display:none!important}amp-experiment,amp-live-list>[update]{display:none}.i-amphtml-jank-meter{position:fixed;background-color:rgba(232,72,95,0.5);bottom:0;right:0;color:#fff;font-size:16px;z-index:1000;padding:5px}amp-list[resizable-children]>.i-amphtml-loading-container.amp-hidden{display:none!important}amp-list [fetch-error],amp-list[load-more] [load-more-button],amp-list[load-more] [load-more-end],amp-list[load-more] [load-more-failed],amp-list[load-more] [load-more-loading]{display:none}amp-list[diffable] div[role=list]{display:block}amp-story-page,amp-story[standalone]{min-height:1px!important;display:block!important;height:100%!important;margin:0!important;padding:0!important;overflow:hidden!important;width:100%!important}amp-story[standalone]{background-color:#202125!important;position:relative!important}amp-story-page{background-color:#757575}amp-story .amp-active>div,amp-story .i-amphtml-loader-background{display:none!important}amp-story-page:not(:first-of-type):not([distance]):not([active]){transform:translateY(1000vh)!important}amp-autocomplete{position:relative!important;display:inline-block!important}amp-autocomplete>input,amp-autocomplete>textarea{padding:0.5rem;border:1px solid rgba(0,0,0,0.33)}.i-amphtml-autocomplete-results,amp-autocomplete>input,amp-autocomplete>textarea{font-size:1rem;line-height:1.5rem}[amp-fx^=fly-in]{visibility:hidden}amp-script[nodom]{position:fixed!important;top:0!important;width:1px!important;height:1px!important;overflow:hidden!important;visibility:hidden}
/*# sourceURL=/css/ampdoc.css*/[hidden]{display:none!important}.i-amphtml-element{display:inline-block}.i-amphtml-blurry-placeholder{transition:opacity 0.3s cubic-bezier(0.0,0.0,0.2,1)!important;pointer-events:none}[layout=nodisplay]:not(.i-amphtml-element){display:none!important}.i-amphtml-layout-fixed,[layout=fixed][width][height]:not(.i-amphtml-layout-fixed){display:inline-block;position:relative}.i-amphtml-layout-responsive,[layout=responsive][width][height]:not(.i-amphtml-layout-responsive),[width][height][heights]:not([layout]):not(.i-amphtml-layout-responsive),[width][height][sizes]:not([layout]):not(.i-amphtml-layout-responsive){display:block;position:relative}.i-amphtml-layout-intrinsic,[layout=intrinsic][width][height]:not(.i-amphtml-layout-intrinsic){display:inline-block;position:relative;max-width:100%}.i-amphtml-layout-intrinsic .i-amphtml-sizer{max-width:100%}.i-amphtml-intrinsic-sizer{max-width:100%;display:block!important}.i-amphtml-layout-container,.i-amphtml-layout-fixed-height,[layout=container],[layout=fixed-height][height]:not(.i-amphtml-layout-fixed-height){display:block;position:relative}.i-amphtml-layout-fill,.i-amphtml-layout-fill.i-amphtml-notbuilt,[layout=fill]:not(.i-amphtml-layout-fill){display:block;overflow:hidden!important;position:absolute;top:0;left:0;bottom:0;right:0}.i-amphtml-layout-flex-item,[layout=flex-item]:not(.i-amphtml-layout-flex-item){display:block;position:relative;-ms-flex:1 1 auto;flex:1 1 auto}.i-amphtml-layout-fluid{position:relative}.i-amphtml-layout-size-defined{overflow:hidden!important}.i-amphtml-layout-awaiting-size{position:absolute!important;top:auto!important;bottom:auto!important}i-amphtml-sizer{display:block!important}@supports (aspect-ratio:1/1){i-amphtml-sizer.i-amphtml-disable-for-ar{display:none!important}}.i-amphtml-blurry-placeholder,.i-amphtml-fill-content{display:block;height:0;max-height:100%;max-width:100%;min-height:100%;min-width:100%;width:0;margin:auto}.i-amphtml-layout-size-defined .i-amphtml-fill-content{position:absolute;top:0;left:0;bottom:0;right:0}.i-amphtml-replaced-content,.i-amphtml-screen-reader{padding:0!important;border:none!important}.i-amphtml-screen-reader{position:fixed!important;top:0px!important;left:0px!important;width:4px!important;height:4px!important;opacity:0!important;overflow:hidden!important;margin:0!important;display:block!important;visibility:visible!important}.i-amphtml-screen-reader~.i-amphtml-screen-reader{left:8px!important}.i-amphtml-screen-reader~.i-amphtml-screen-reader~.i-amphtml-screen-reader{left:12px!important}.i-amphtml-screen-reader~.i-amphtml-screen-reader~.i-amphtml-screen-reader~.i-amphtml-screen-reader{left:16px!important}.i-amphtml-unresolved{position:relative;overflow:hidden!important}.i-amphtml-select-disabled{-webkit-user-select:none!important;-ms-user-select:none!important;user-select:none!important}.i-amphtml-notbuilt,[layout]:not(.i-amphtml-element),[width][height][heights]:not([layout]):not(.i-amphtml-element),[width][height][sizes]:not([layout]):not(.i-amphtml-element){position:relative;overflow:hidden!important;color:transparent!important}.i-amphtml-notbuilt:not(.i-amphtml-layout-container)>*,[layout]:not([layout=container]):not(.i-amphtml-element)>*,[width][height][heights]:not([layout]):not(.i-amphtml-element)>*,[width][height][sizes]:not([layout]):not(.i-amphtml-element)>*{display:none}amp-img:not(.i-amphtml-element)[i-amphtml-ssr]>img.i-amphtml-fill-content{display:block}.i-amphtml-notbuilt:not(.i-amphtml-layout-container),[layout]:not([layout=container]):not(.i-amphtml-element),[width][height][heights]:not([layout]):not(.i-amphtml-element),[width][height][sizes]:not([layout]):not(.i-amphtml-element){color:transparent!important;line-height:0!important}.i-amphtml-ghost{visibility:hidden!important}.i-amphtml-element>[placeholder],[layout]:not(.i-amphtml-element)>[placeholder],[width][height][heights]:not([layout]):not(.i-amphtml-element)>[placeholder],[width][height][sizes]:not([layout]):not(.i-amphtml-element)>[placeholder]{display:block}.i-amphtml-element>[placeholder].amp-hidden,.i-amphtml-element>[placeholder].hidden{visibility:hidden}.i-amphtml-element:not(.amp-notsupported)>[fallback],.i-amphtml-layout-container>[placeholder].amp-hidden,.i-amphtml-layout-container>[placeholder].hidden{display:none}.i-amphtml-layout-size-defined>[fallback],.i-amphtml-layout-size-defined>[placeholder]{position:absolute!important;top:0!important;left:0!important;right:0!important;bottom:0!important;z-index:1}.i-amphtml-notbuilt>[placeholder]{display:block!important}.i-amphtml-hidden-by-media-query{display:none!important}.i-amphtml-element-error{background:red!important;color:#fff!important;position:relative!important}.i-amphtml-element-error:before{content:attr(error-message)}i-amp-scroll-container,i-amphtml-scroll-container{position:absolute;top:0;left:0;right:0;bottom:0;display:block}i-amp-scroll-container.amp-active,i-amphtml-scroll-container.amp-active{overflow:auto;-webkit-overflow-scrolling:touch}.i-amphtml-loading-container{display:block!important;pointer-events:none;z-index:1}.i-amphtml-notbuilt>.i-amphtml-loading-container{display:block!important}.i-amphtml-loading-container.amp-hidden{visibility:hidden}.i-amphtml-element>[overflow]{cursor:pointer;position:relative;z-index:2;visibility:hidden;display:initial;line-height:normal}.i-amphtml-element>[overflow].amp-visible{visibility:visible}template{display:none!important}.amp-border-box,.amp-border-box *,.amp-border-box :after,.amp-border-box :before{box-sizing:border-box}amp-pixel{display:none!important}amp-analytics,amp-auto-ads,amp-story-auto-ads{position:fixed!important;top:0!important;width:1px!important;height:1px!important;overflow:hidden!important;visibility:hidden}html.i-amphtml-fie>amp-analytics{position:initial!important}[visible-when-invalid]:not(.visible),form [submit-error],form [submit-success],form [submitting]{display:none}amp-accordion{display:block!important}amp-accordion>section{float:none!important}amp-accordion>section>*{float:none!important;display:block!important;overflow:hidden!important;position:relative!important}amp-accordion,amp-accordion>section{margin:0}amp-accordion:not(.i-amphtml-built)>section>:last-child{display:none!important}amp-accordion:not(.i-amphtml-built)>section[expanded]>:last-child{display:block!important}
/*# sourceURL=/css/ampshared.css*/</style><meta name="description" content="WebAssembly Advent Calendar 2018の20日目の記事。"><meta property="og:title" content="Rust + wasm-bindgen + WebWorkerの環境構築"><meta property="og:description" content="WebAssembly Advent Calendar 2018の20日目の記事。"><meta property="og:type" content="article"><meta property="og:url" content="https://imasanari.github.io/blog/wasm-bindgen-with-worker"><meta property="og:image" content="https://imasanari.github.io/images/icon.jpg"><meta property="og:site_name" content="Tech SANDBOX"><meta name="twitter:card" content="summary"><meta name="next-head-count" content="10"><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"><link rel="preload" href="https://cdn.ampproject.org/v0.js" as="script"><script async src="https://cdn.ampproject.org/v0.js"></script><title>Rust + wasm-bindgen + WebWorkerの環境構築 | Tech SANDBOX</title><link rel="canonical" href="/blog/wasm-bindgen-with-worker"><style amp-custom>.SiteTitle.jsx-2257550242{font-size:2rem;margin:1rem 0}.Header.jsx-2935353441{padding-top:0}.Tags.jsx-1424798431{padding:0}.item.jsx-1424798431{display:inline;margin:0 .2em}.link.jsx-1424798431{color:var(--color-text-secondary)}.PostPager.jsx-2638938446{display:table;max-width:var(--width-content);margin:2rem auto}.item.jsx-2638938446{box-sizing:border-box;display:table-cell;width:33.3%;padding:.5rem;text-align:center;vertical-align:middle}.home.jsx-2638938446{border-left:1px solid #6c6c6c;border-right:1px solid #6c6c6c}.Posts.jsx-2000003725{list-style:none;padding:0}.Posts-item.jsx-2000003725{padding:1rem 1.5rem;margin:1rem 0;border:1px solid #bbb}.Footer.jsx-101915585{text-align:center}:root{--border-radius:5px;--box-shadow:2px 2px 10px;--color:#118bee;--color-accent:rgba(17,139,238,0.08);--color-bg:#fff;--color-bg-secondary:#e9e9e9;--color-secondary:#920de9;--color-secondary-accent:rgba(146,13,233,0.04);--color-shadow:#f4f4f4;--color-text:#000;--color-text-secondary:#999;--font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;--hover-brightness:1.2;--justify-important:center;--justify-normal:left;--line-height:1.5;--width-card:285px;--width-card-medium:460px;--width-card-wide:800px;--width-content:1080px}article aside{background:var(--color-secondary-accent);border-left:4px solid var(--color-secondary);padding:.01rem .8rem}body{background:var(--color-bg);color:var(--color-text);font-family:var(--font-family);line-height:var(--line-height);margin:0;overflow-x:hidden;padding:1rem 0}footer,header,main{margin:0 auto;max-width:var(--width-content);padding:2rem 1rem}hr{background-color:var(--color-bg-secondary);border:none;height:1px;margin:4rem 0}section{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:var(--justify-important);-webkit-justify-content:var(--justify-important);-ms-flex-pack:var(--justify-important);justify-content:var(--justify-important)}section aside{border:1px solid var(--color-bg-secondary);border-radius:var(--border-radius);box-shadow:var(--box-shadow) var(--color-shadow);margin:1rem;padding:1.25rem;width:var(--width-card)}section aside:hover{box-shadow:var(--box-shadow) var(--color-bg-secondary)}section aside img{max-width:100%}[hidden]{display:none}article header,div header,main header{padding-top:0}header{text-align:var(--justify-important)}header a b,header a em,header a i,header a strong{margin-left:.5rem;margin-right:.5rem}header nav img{margin:1rem 0}section header{padding-top:0;width:100%}nav{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-weight:700;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;margin-bottom:7rem}nav ul{list-style:none;padding:0}nav ul li{display:inline-block;margin:0 .5rem;position:relative;text-align:left}nav ul li:hover ul{display:block}nav ul li ul{background:var(--color-bg);border:1px solid var(--color-bg-secondary);border-radius:var(--border-radius);box-shadow:var(--box-shadow) var(--color-shadow);display:none;height:auto;left:-2px;padding:.5rem 1rem;position:absolute;top:1.7rem;white-space:nowrap;width:auto}nav ul li ul li,nav ul li ul li a{display:block}code,samp{background-color:var(--color-accent);border-radius:var(--border-radius);color:var(--color-text);display:inline-block;margin:0 .1rem;padding:0 .5rem}details{margin:1.3rem 0}details summary{font-weight:700;cursor:pointer}h1,h2,h3,h4,h5,h6{line-height:var(--line-height)}mark{padding:.1rem}ol li,ul li{padding:.2rem 0}p{margin:.75rem 0;padding:0}pre{margin:1rem 0;padding:1rem 0}pre,pre code,pre samp{max-width:var(--width-card-wide)}pre code,pre samp{display:block;padding:.5rem 2rem;white-space:pre-wrap}small{color:var(--color-text-secondary)}sup{background-color:var(--color-secondary);border-radius:var(--border-radius);color:var(--color-bg);font-size:xx-small;margin:.2rem;padding:.2rem .3rem;position:relative;top:-2px}a,sup{font-weight:700}a{color:var(--color-secondary);display:inline-block;-webkit-text-decoration:none;text-decoration:none}a:hover{-webkit-filter:brightness(var(--hover-brightness));filter:brightness(var(--hover-brightness));-webkit-text-decoration:underline;text-decoration:underline}a b,a em,a i,a strong,button{border-radius:var(--border-radius);display:inline-block;font-size:medium;font-weight:700;line-height:var(--line-height);margin:.5rem 0;padding:1rem 2rem}button{font-family:var(--font-family)}button:hover{cursor:pointer;-webkit-filter:brightness(var(--hover-brightness));filter:brightness(var(--hover-brightness))}a b,a strong,button{background-color:var(--color);color:var(--color-bg)}a b,a em,a i,a strong,button{border:2px solid var(--color)}a em,a i{border-radius:var(--border-radius);color:var(--color);display:inline-block;padding:1rem 2rem}figure{margin:0;padding:0}figure img{max-width:100%}figure figcaption{color:var(--color-text-secondary)}button:disabled,input:disabled{background:var(--color-bg-secondary);border-color:var(--color-bg-secondary);color:var(--color-text-secondary);cursor:not-allowed}button[disabled]:hover{-webkit-filter:none;filter:none}form{border:1px solid var(--color-bg-secondary);border-radius:var(--border-radius);box-shadow:var(--box-shadow) var(--color-shadow);display:block;max-width:var(--width-card-wide);min-width:var(--width-card);padding:1.5rem;text-align:var(--justify-normal)}form header{margin:1.5rem 0;padding:1.5rem 0}input,label,select,textarea{display:block;font-size:inherit;max-width:var(--width-card-wide)}input[type=checkbox],input[type=radio]{display:inline-block}input[type=checkbox]+label,input[type=radio]+label{display:inline-block;font-weight:400;position:relative;top:1px}input,select,textarea{border:1px solid var(--color-bg-secondary);border-radius:var(--border-radius);margin-bottom:1rem;padding:.4rem .8rem}input[readonly],textarea[readonly]{background-color:var(--color-bg-secondary)}label{font-weight:700;margin-bottom:.2rem}table{border:1px solid var(--color-bg-secondary);border-radius:var(--border-radius);border-spacing:0;display:inline-block;max-width:100%;overflow-x:auto;padding:0;white-space:nowrap}table td,table th,table tr{padding:.4rem .8rem;text-align:var(--justify-important)}table thead{background-color:var(--color);border-collapse:collapse;border-radius:var(--border-radius);color:var(--color-bg);margin:0;padding:0}table thead th:first-child{border-top-left-radius:var(--border-radius)}table thead th:last-child{border-top-right-radius:var(--border-radius)}table thead th:first-child,table tr td:first-child{text-align:var(--justify-normal)}table tr:nth-child(2n){background-color:var(--color-accent)}blockquote{font-size:x-large;margin:1rem auto;max-width:var(--width-card-medium);padding:1.5rem 1rem;text-align:var(--justify-important)}blockquote,blockquote footer{display:block;line-height:var(--line-height)}blockquote footer{color:var(--color-text-secondary);font-size:small;padding:1.5rem 0}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}main{display:block}header+main{padding-top:0}header:last-child{padding-bottom:0}pre{overflow:auto;max-width:none;padding:.5rem 2rem;background:#272822}pre code,pre samp{display:inline;padding:0}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:transparent}@media (prefers-color-scheme:dark){:root{--color:#0097fc;--color-accent:rgba(0,151,252,0.31);--color-bg:#333;--color-bg-secondary:#555;--color-secondary:#e20de9;--color-secondary-accent:rgba(226,13,233,0.31);--color-shadow:hsla(0,0%,73.3%,0.13);--color-text:#f7f7f7;--color-text-secondary:#aaa}}</style></head><body><!-- __NEXT_DATA__ --><header class="jsx-2935353441 Header"><div class="jsx-2257550242 SiteTitle"><a class="jsx-2257550242" href="/">Tech SANDBOX</a></div><p class="jsx-2935353441">技術ブログ改め、Qiitaの下書き</p></header><div><article><header><time datetime="2018-12-20T14:58:37.388Z">2018-12-20</time><h1>Rust + wasm-bindgen + WebWorkerの環境構築</h1><ul class="jsx-1424798431 Tags"><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/Rust/">#Rust</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/wasm-bindgen/">#wasm-bindgen</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/TypeScript/">#TypeScript</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/parcel/">#parcel</a></li></ul></header><main><div><p><a href="https://qiita.com/advent-calendar/2018/wasm">WebAssembly Advent Calendar 2018</a>の20日目の記事。
※ 2019/4/20: 修正</p><h2 id="tldr">TL;DR</h2><p>parcelのparcel-plugin-wasm.rsプラグインを使用しよう！</p><p>サンプルリポジトリはこちら
<a href="https://github.com/iMasanari/wasm-bindgen-with-worker">iMasanari/wasm-bindgen-with-worker</a></p><h2 id="やりたいこと">やりたいこと</h2><p>時間のかかる処理をWebAssemblyで高速に行いたい。そのためには、下記の条件が必要になる。</p><ul><li>引数や戻り値をJSON形式でやりとりできること</li><li>非同期処理であること</li></ul><p>今回は、Rustでwasm-bindgenを使用し、WebWorker内で動かす環境を作っていく。</p><h2 id="1度、webpackで構築するも">1度、WebPackで構築するも……</h2><p>まずは、<a href="https://www.mizdra.net/entry/2018/10/17/080000">WebAssemblyを使って乱数調整ツールをWebに移植した話</a>を元に、WebPackで構築した。しかし、3つの気になる点が出てきた。</p><ul><li>Worker用のエントリーファイルをもう1つ用意しなければならない<ul><li><a href="https://github.com/webpack/webpack/issues/7647">Cannot import wasm in web workers #7647</a></li></ul></li><li>中間ファイル生成（Rust→wasm）のせいで、ビルドタスクが煩雑になる</li><li>ライブリロード<ul><li>ワンテンポ遅いタイミングでページ全体のリロードがされる</li><li>リロードの読み込み時間も長い</li></ul></li></ul><p>エントリーファイルの問題は、WebWorkerのファイル名にハッシュ（<code>worker.2290ab9e.js</code>の<code>2290ab9e</code>部分）が付けられないことである。今回はスクリプトがView、WebWorker、WASMの3ファイルに分かれるので、キャッシュ対策のためにも必要度は高い。</p><h2 id="parcelでの環境構築">parcelでの環境構築</h2><p>Webpackで環境を作って数日後、ふと別のモジュールバンドラを使用すればよいのではと思い、parcelで試してみた。すると、上記のエントリーファイル問題、中間ファイル問題を解決することができた。
ライブリロードの件は一応差分更新を試みてくれるが、Rustの更新内容は反映されなかった。ただ、普段ライブリロードは使わず、またワンテンポ遅れの全リロードでないためそこまで問題は感じていない。</p><p>なぜ最初にparcelで試さなかったのかというと、情報がWebpackのものしかなかったからだ。なので今回、parcelでWebWorker + WebAssemblyを扱う方法を共有したい。（といっても、parcelがゼロコンフィグなモジュールバンドラのため、そこまで凝ったことはしていない）</p><h2 id="各種インストール">各種インストール</h2><p>Node.jsやRustはインストール済みとする。</p><p>parcelのインストール</p><p><del>parcel-plugin-wasm.rs v1.2.7はparcel-bundler v1.11.0に対応していないのかビルドエラーになったため、バージョンを指定してインストールしている。</del></p><p>※最新バージョンで治っていることを確認。</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers>$ <span class="token function">npm</span> <span class="token function">install</span> -D parcel-bundler parcel-plugin-wasm.rs
</code></pre><p>parcel-plugin-wasm.rsはRustをwasm-packでコンパイルするためのparcelのプラグイン。wasm-packのインストールがまだの場合はインストールする。</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers>$ cargo <span class="token function">install</span> wasm-pack
</code></pre><p>個人的にいつもTypeScriptを使うので、それ関連のインストール。
<a href="https://www.npmjs.com/package/@types/webassembly-js-api">@types/webassembly-js-api</a>は、WebAssemblyの型定義。</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers>$ <span class="token function">npm</span> <span class="token function">install</span> -D typescript @types/webassembly-js-api
</code></pre><h2 id="フォルダ構成と設定ファイル">フォルダ構成と設定ファイル</h2><h3 id="フォルダ構成（srcフォルダ）">フォルダ構成（srcフォルダ）</h3><p>各種フォルダとエントリーポイントのHTMLという構成で、個人的にすごくきれいな配置だと思う。
ちなみにこの出力をするためにMacへTreeコマンドを入れた。</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers>$ tree src
src
├── app
│   └── index.ts
├── wasm
│   ├── lib.rs
│   └── lib.rs.d.ts
├── worker
│   └── index.ts
└── index.html
</code></pre><h3 id="各種設定ファイル（必要最低限の箇所のみ）">各種設定ファイル（必要最低限の箇所のみ）</h3><pre><code class="language-json" data-language="json" data-highlighted-line-numbers><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"parcel src/index.html"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"parcel build src/index.html"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"@types/webassembly-js-api"</span><span class="token operator">:</span> <span class="token string">"0.0.3"</span><span class="token punctuation">,</span>
    <span class="token property">"parcel-bundler"</span><span class="token operator">:</span> <span class="token string">"^1.12.3"</span><span class="token punctuation">,</span>
    <span class="token property">"parcel-plugin-wasm.rs"</span><span class="token operator">:</span> <span class="token string">"^1.2.8"</span><span class="token punctuation">,</span>
    <span class="token property">"typescript"</span><span class="token operator">:</span> <span class="token string">"^3.4.2"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"browserslist"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"last 2 chrome versions"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><pre><code class="language-toml" data-language="toml" data-highlighted-line-numbers><span class="token comment"># Cargo.toml</span>
<span class="token punctuation">[</span><span class="token table class-name">package</span><span class="token punctuation">]</span>
<span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"wasm"</span>
<span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.1.0"</span>

<span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">wasm-bindgen</span> <span class="token punctuation">=</span> <span class="token string">"^0.2"</span>

<span class="token punctuation">[</span><span class="token table class-name">lib</span><span class="token punctuation">]</span>
<span class="token key property">crate-type</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"cdylib"</span><span class="token punctuation">]</span>
<span class="token key property">path</span> <span class="token punctuation">=</span> <span class="token string">"./src/wasm/lib.rs"</span>
</code></pre><pre><code class="language-json" data-language="json" data-highlighted-line-numbers><span class="token comment">// tsconfig.json</span>
<span class="token punctuation">{</span>
  <span class="token property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"es2015"</span><span class="token punctuation">,</span>
    <span class="token property">"lib"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"es2015"</span><span class="token punctuation">,</span>
      <span class="token string">"dom"</span><span class="token punctuation">,</span>
      <span class="token string">"webworker"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"strict"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"esModuleInterop"</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>WebAssembly未対応のIEを切り捨て、TypeScriptのコンパイルはes2015で行っている。parcelのbabel側でes5に変換されないよう、<code>package.json</code>では<code>browserslist</code>の設定を行う。</p><h2 id="各ファイル">各ファイル</h2><p>全部書くのも面倒なので、各ファイルのインポート部分だけ書いていく。
書き足している場所もあるが、全体はサンプルリポジトリを参照。
<a href="https://github.com/iMasanari/wasm-bindgen-with-worker">iMasanari/wasm-bindgen-with-worker</a></p><pre><code class="language-markup" data-language="markup" data-highlighted-line-numbers><span class="token comment">&lt;!-- src/index.html --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app/index.ts<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
</code></pre><pre><code class="language-typescript" data-language="typescript" data-highlighted-line-numbers><span class="token comment">// src/app/index.ts</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'../worker/index.ts'</span><span class="token punctuation">)</span>
</code></pre><pre><code class="language-typescript" data-language="typescript" data-highlighted-line-numbers><span class="token comment">// src/worker/index.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> wasm <span class="token keyword">from</span> <span class="token string">'../wasm/lib.rs'</span>

<span class="token comment">// WebAssemblyの実行</span>
wasm<span class="token punctuation">.</span><span class="token function">some_function</span><span class="token punctuation">(</span><span class="token string">'WebAssembly'</span><span class="token punctuation">)</span>
</code></pre><p>あとは、Rustの関数を作るだけ。
現在のWebAssemblyは数値しかやりとりができないが、wasm-bindgenを使うことで文字列やJSONもやりとりができるようになる。</p><pre><code class="language-rust" data-language="rust" data-highlighted-line-numbers><span class="token comment">// src/wasm/lib.rs</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">wasm_bindgen</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">wasm_bindgen<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[wasm_bindgen]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">some_function</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"Hello, {}!"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>ビルドも下記コマンドだけでOK。
初回だけ、Rustのビルドに時間がかかる。</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers><span class="token comment"># デバッグ用ビルド + サーバー</span>
$ <span class="token function">npm</span> run dev
</code></pre><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers><span class="token comment"># プロダクションビルド</span>
$ <span class="token function">npm</span> run build
</code></pre><p>出力結果はこんな感じ。
なぜか<code>lib.rs</code>まで出力されているが、ちゃんとハッシュが付いているのが確認できる。</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers>$ tree dist
dist
├── app.68414551.js
├── index.html
├── lib.3d22fd5b.rs
├── wasm_bg.ead9fc9c.wasm
└── worker.135e8d27.js
</code></pre><h2 id="webpackとの違い">Webpackとの違い</h2><h3 id="rustからのjavascriptコード呼び出しパス">RustからのJavaScriptコード呼び出しパス</h3><p>Webpackでは、pkgフォルダ内のファイルをインポートするため、相対パスの基準は<code>pkg/</code>である。
parcel(parcel-plugin-wasm.rs)では、<code>node_modules/parcel-plugin-wasm.rs/</code>が基準である。parcelの絶対パス（<code>/*</code>）を使えば、エントリーファイルの場所（今回は<code>src/</code>）が基準になる。</p><pre><code class="language-rust" data-language="rust" data-highlighted-line-numbers><span class="token comment">// src/wasm/lib.rs</span>
<span class="token attribute attr-name">#[wasm_bindgen(module = <span class="token string">"/worker/wasm-util"</span>)]</span>
<span class="token keyword">extern</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">console_log</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="webworker側でのrustインポート">WebWorker側でのRustインポート</h3><p>Webpackでは、WASMをインポートするまでに必ずDynamic importを挟む必要がある。
parcelではその必要がなく、直接importする。（そもそもWebWroker内でのDynamic importがサポートされていない？）</p><p>つまり、parcelではWASMロード中の<code>postMessage</code>を取りこぼしてしまう可能性がある。
そのため<a href="https://github.com/iMasanari/wasm-bindgen-with-worker">サンプル</a>では、<a href="https://github.com/iMasanari/wasm-bindgen-with-worker/blob/master/src/app/wasmWorker.ts#L24">ロードを待ってからメッセージを送る</a>ようにしている。</p><h2 id="まとめ">まとめ</h2><p>parcelを使うことで、簡単にWebAssemblyが始められる。</p><p>ちなみにRustは、C言語並みの処理スピードを持ちながらモダンな文法と強力なコンパイル時チェックを備えている言語でおすすめ！　所有権、借用、ライフタイム？　学習コストが高い？　知らんな。一緒に<a href="https://doc.rust-jp.rs/the-rust-programming-language-ja/1.6/book/references-and-borrowing.html#%E6%A6%82%E8%AB%96">借用チェッカと戦おうぜ！</a> by Rust初心者</p></div></main></article><div class="jsx-2638938446 PostPager"><div class="jsx-2638938446 item"><a class="jsx-2638938446" href="/blog/difference-between-jsx-and-html/">HTMLでは使えないJSX独自の書き方</a></div><div class="jsx-2638938446 item home"><a class="jsx-2638938446" href="/">HOME</a></div><div class="jsx-2638938446 item"><a class="jsx-2638938446" href="/blog/use-parcel/">ブログ開発をParcelに変更した</a></div></div><aside><header><h1>同じタグを含む記事</h1><ul class="jsx-1424798431 Tags"><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/Rust/">#Rust</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/wasm-bindgen/">#wasm-bindgen</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/TypeScript/">#TypeScript</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/parcel/">#parcel</a></li></ul></header><main><ul class="jsx-2000003725 Posts"><li class="jsx-2000003725 Posts-item"><article class="jsx-2000003725"><header><time datetime="2019-04-26T13:55:56.097Z">2019-04-26</time><h1><a href="/blog/use-parcel/">ブログ開発をParcelに変更した</a></h1><ul class="jsx-1424798431 Tags"><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/parcel/">#parcel</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/blog/">#blog</a></li></ul></header></article></li><li class="jsx-2000003725 Posts-item"><article class="jsx-2000003725"><header><time datetime="2018-07-13T12:47:36.148Z">2018-07-13</time><h1><a href="/blog/remove-object-key/">【ES.next】Objectから任意のキーを削除した新しいObjectを作成する</a></h1><ul class="jsx-1424798431 Tags"><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/JavaScript/">#JavaScript</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/Babel/">#Babel</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/TypeScript/">#TypeScript</a></li></ul></header></article></li><li class="jsx-2000003725 Posts-item"><article class="jsx-2000003725"><header><time datetime="2018-07-03T11:47:13.910Z">2018-07-03</time><h1><a href="/blog/webpacks-rules-in-static-config-js/">React StaticでTypeScriptを使用した時のエラー対処法</a></h1><ul class="jsx-1424798431 Tags"><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/ReactStatic/">#ReactStatic</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/TypeScript/">#TypeScript</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/webpack/">#webpack</a></li></ul></header></article></li></ul></main></aside></div><footer class="jsx-101915585 Footer"><p class="jsx-101915585">Author: <a href="https://github.com/iMasanari" class="jsx-101915585">iMasanari</a></p><small class="jsx-101915585"><a href="https://github.com/iMasanari/imasanari.github.io/" class="jsx-101915585">Show on GitHub</a></small></footer></body></html>