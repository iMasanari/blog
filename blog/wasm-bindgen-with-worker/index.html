<!DOCTYPE html><html lang="ja-JP" prefix="og: http://ogp.me/ns#"><head><link href="/src.9be82b6d.js" rel="preload" as="script"><meta charset="UTF-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="ie=edge" http-equiv="X-UA-Compatible"><style>
  *,:after,:before{box-sizing:border-box}html{font-family:sans-serif;line-height:1.15;-webkit-text-size-adjust:100%}article,header,section{display:block}body{margin:0;font-family:HelveticaNeue-Light,Helvetica Neue Light,Helvetica Neue,Helvetica,Arial,Lucida Grande,sans-serif;font-size:1rem;font-weight:300;line-height:1.5;color:#212529;text-align:left;background-color:#fff}h1,h2{margin-top:0;margin-bottom:.5rem}p{margin-top:0;margin-bottom:1rem}ul{margin-bottom:1rem}ul{margin-top:0}ul ul{margin-bottom:0}a{color:#007bff;text-decoration:none;background-color:transparent}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}.nes-container.is-rounded,.nes-container.is-rounded.is-dark{border-style:solid;border-width:4px}.nes-container{position:relative;padding:1.5rem 2rem;border:4px solid #000}.nes-container>:last-child{margin-bottom:0}.nes-container.with-title>.title{display:table;padding:0 .5rem;margin:-1.8rem 0 1rem;font-size:1rem;background-color:#fff}.nes-container.is-dark{position:relative;margin:4px;color:#fff;background-color:#212529;border-color:#fff}.nes-container.is-dark:after{position:absolute;top:-7.2px;right:-7.2px;bottom:-7.2px;left:-7.2px;z-index:-1;content:"";background-color:#212529}.nes-container.is-rounded{border-image-slice:3;border-image-width:3;border-image-repeat:stretch;border-image-source:url('data:image/svg+xml;utf8,<?xml version="1.0" encoding="UTF-8" ?><svg version="1.1" width="8" height="8" xmlns="http://www.w3.org/2000/svg"><path d="M3 1 h1 v1 h-1 z M4 1 h1 v1 h-1 z M2 2 h1 v1 h-1 z M5 2 h1 v1 h-1 z M1 3 h1 v1 h-1 z M6 3 h1 v1 h-1 z M1 4 h1 v1 h-1 z M6 4 h1 v1 h-1 z M2 5 h1 v1 h-1 z M5 5 h1 v1 h-1 z M3 6 h1 v1 h-1 z M4 6 h1 v1 h-1 z" fill="rgb(33,37,41)" /></svg>');border-image-outset:2;padding:1rem 1.5rem;margin:4px}@media (-webkit-min-device-pixel-ratio:0) and (min-resolution:0.001dpcm){.nes-container.is-rounded{border-image-repeat:space}}@supports (-moz-appearance:meterbar){.nes-container.is-rounded{border-image-repeat:stretch}}.nes-container.is-rounded.with-title>.title{margin-top:-1.5rem}.nes-container.is-rounded.is-dark{border-image-slice:3;border-image-width:3;border-image-repeat:stretch;border-image-source:url('data:image/svg+xml;utf8,<?xml version="1.0" encoding="UTF-8" ?><svg version="1.1" width="8" height="8" xmlns="http://www.w3.org/2000/svg"><path d="M3 1 h1 v1 h-1 z M4 1 h1 v1 h-1 z M2 2 h1 v1 h-1 z M5 2 h1 v1 h-1 z M1 3 h1 v1 h-1 z M6 3 h1 v1 h-1 z M1 4 h1 v1 h-1 z M6 4 h1 v1 h-1 z M2 5 h1 v1 h-1 z M5 5 h1 v1 h-1 z M3 6 h1 v1 h-1 z M4 6 h1 v1 h-1 z" fill="rgb(255,255,255)" /></svg>');border-image-outset:0}@media (-webkit-min-device-pixel-ratio:0) and (min-resolution:0.001dpcm){.nes-container.is-rounded.is-dark{border-image-repeat:space}}@supports (-moz-appearance:meterbar){.nes-container.is-rounded.is-dark{border-image-repeat:stretch}}.nes-container.is-rounded.is-dark:after{content:none}.nes-container.is-rounded{margin-bottom:32px}@media (max-width:500px){.shared-main-container{padding:0 4px;border:none}}.PostTags,.PostTags-li{display:inline;padding:0;margin:0}.PostTags-Link{color:#6c6c6c}.Post-header{margin-bottom:32px}@media (max-width:500px){.Post-header{padding-right:16px;padding-left:16px}}.Header{background:#108db8;box-shadow:0 5px 15px -5px rgba(0,0,0,.8);margin:0!important}.Header-title{padding:1rem;text-align:center}.Header-title a{color:#fff}.App{display:flex;flex-direction:column;min-height:100vh}.App-content{flex:1;box-sizing:border-box;width:100%;max-width:700px;margin:2rem auto}
</style>
<link href="/src.390a82d0.css" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="/src.390a82d0.css" rel="stylesheet"></noscript>
<script>!function(n){"use strict";n.loadCSS||(n.loadCSS=function(){});var o=loadCSS.relpreload={};if(o.support=function(){var e;try{e=n.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),o.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.addEventListener?t.removeEventListener("load",a):t.attachEvent&&t.detachEvent("onload",a),t.setAttribute("onload",null),t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},o.poly=function(){if(!o.support())for(var t=n.document.getElementsByTagName("link"),e=0;e<t.length;e++){var a=t[e];"preload"!==a.rel||"style"!==a.getAttribute("as")||a.getAttribute("data-loadcss")||(a.setAttribute("data-loadcss",!0),o.bindMediaToggle(a))}},!o.support()){o.poly();var t=n.setInterval(o.poly,500);n.addEventListener?n.addEventListener("load",function(){o.poly(),n.clearInterval(t)}):n.attachEvent&&n.attachEvent("onload",function(){o.poly(),n.clearInterval(t)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:n.loadCSS=loadCSS}("undefined"!=typeof global?global:this);</script><script src="https://www.googletagmanager.com/gtag/js?id=UA-74494516-4" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-74494516-4")</script><title>Rust + wasm-bindgen + WebWorkerの環境構築 - Tech SANDBOX</title><meta content="WebAssembly Advent Calendar 2018の20日目の記事。" name="description"><meta content="Rust + wasm-bindgen + WebWorkerの環境構築 - Tech SANDBOX" property="og:title"><meta content="article" property="og:type"><meta content="WebAssembly Advent Calendar 2018の20日目の記事。" property="og:description"><meta content="https://imasanari.github.io/blog/wasm-bindgen-with-worker/" property="og:url"><meta content="https://imasanari.github.io/images/icon.jpg" property="og:image"><meta content="summary" name="twitter:card"></head><body> <div id="app"><div class="App"><header class="nes-container is-rounded is-dark Header"><h1 class="Header-title"><a href="/">Tech SANDBOX</a></h1></header><div class="App-content"><div><article class="nes-container shared-main-container"><div class="Post-header"><span>2018-12-20</span><h1>Rust + wasm-bindgen + WebWorkerの環境構築</h1><ul class="PostTags"><li class="PostTags-li"> <a href="/tags/Rust/" class="PostTags-Link">#Rust</a></li><li class="PostTags-li"> <a href="/tags/wasm-bindgen/" class="PostTags-Link">#wasm-bindgen</a></li><li class="PostTags-li"> <a href="/tags/TypeScript/" class="PostTags-Link">#TypeScript</a></li><li class="PostTags-li"> <a href="/tags/parcel/" class="PostTags-Link">#parcel</a></li></ul></div><div><section class="nes-container is-rounded with-title"><p><a href="https://qiita.com/advent-calendar/2018/wasm" rel="noopener" target="_blank">WebAssembly Advent Calendar 2018</a>の20日目の記事。<br>※ 2019/4/20: 修正</p></section><section class="nes-container is-rounded with-title"><h2 class="title">TL;DR</h2><p>parcelのparcel-plugin-wasm.rsプラグインを使用しよう！</p><p>サンプルリポジトリはこちら<br><a href="https://github.com/iMasanari/wasm-bindgen-with-worker" rel="noopener" target="_blank">iMasanari/wasm-bindgen-with-worker</a></p></section><section class="nes-container is-rounded with-title"><h2 class="title">やりたいこと</h2><p>時間のかかる処理をWebAssemblyで高速に行いたい。そのためには、下記の条件が必要になる。</p><ul><li>引数や戻り値をJSON形式でやりとりできること</li><li>非同期処理であること</li></ul><p>今回は、Rustでwasm-bindgenを使用し、WebWorker内で動かす環境を作っていく。</p></section><section class="nes-container is-rounded with-title"><h2 class="title">1度、WebPackで構築するも……</h2><p>まずは、<a href="https://www.mizdra.net/entry/2018/10/17/080000" rel="noopener" target="_blank">WebAssemblyを使って乱数調整ツールをWebに移植した話</a>を元に、WebPackで構築した。しかし、3つの気になる点が出てきた。</p><ul><li>Worker用のエントリーファイルをもう1つ用意しなければならない<ul><li><a href="https://github.com/webpack/webpack/issues/7647" rel="noopener" target="_blank">Cannot import wasm in web workers #7647</a></li></ul></li><li>中間ファイル生成（Rust→wasm）のせいで、ビルドタスクが煩雑になる</li><li>ライブリロード<ul><li>ワンテンポ遅いタイミングでページ全体のリロードがされる</li><li>リロードの読み込み時間も長い</li></ul></li></ul><p>エントリーファイルの問題は、WebWorkerのファイル名にハッシュ（<code>worker.2290ab9e.js</code>の<code>2290ab9e</code>部分）が付けられないことである。今回はスクリプトがView、WebWorker、WASMの3ファイルに分かれるので、キャッシュ対策のためにも必要度は高い。</p></section><section class="nes-container is-rounded with-title"><h2 class="title">parcelでの環境構築</h2><p>Webpackで環境を作って数日後、ふと別のモジュールバンドラを使用すればよいのではと思い、parcelで試してみた。すると、上記のエントリーファイル問題、中間ファイル問題を解決することができた。<br>ライブリロードの件は一応差分更新を試みてくれるが、Rustの更新内容は反映されなかった。ただ、普段ライブリロードは使わず、またワンテンポ遅れの全リロードでないためそこまで問題は感じていない。</p><p>なぜ最初にparcelで試さなかったのかというと、情報がWebpackのものしかなかったからだ。なので今回、parcelでWebWorker + WebAssemblyを扱う方法を共有したい。（といっても、parcelがゼロコンフィグなモジュールバンドラのため、そこまで凝ったことはしていない）</p></section><section class="nes-container is-rounded with-title"><h2 class="title">各種インストール</h2><p>Node.jsやRustはインストール済みとする。</p><p>parcelのインストール</p><p><del>parcel-plugin-wasm.rs v1.2.7はparcel-bundler v1.11.0に対応していないのかビルドエラーになったため、バージョンを指定してインストールしている。</del> ※最新バージョンで治っていることを確認。</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> -D parcel-bundler parcel-plugin-wasm.rs
</code></pre><p>parcel-plugin-wasm.rsはRustをwasm-packでコンパイルするためのparcelのプラグイン。wasm-packのインストールがまだの場合はインストールする。</p><pre class="language-bash"><code class="language-bash">$ cargo <span class="token function">install</span> wasm-pack
</code></pre><p>個人的にいつもTypeScriptを使うので、それ関連のインストール。<br><a href="https://www.npmjs.com/package/@types/webassembly-js-api" rel="noopener" target="_blank">@types/webassembly-js-api</a>は、WebAssemblyの型定義。</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> -D typescript @types/webassembly-js-api
</code></pre></section><section class="nes-container is-rounded with-title"><h2 class="title">フォルダ構成と設定ファイル</h2><h3>フォルダ構成（srcフォルダ）</h3><p>各種フォルダとエントリーポイントのHTMLという構成で、個人的にすごくきれいな配置だと思う。<br>ちなみにこの出力をするためにMacへTreeコマンドを入れた。</p><pre class="language-bash"><code class="language-bash">$ tree src
src
├── app
│   └── index.ts
├── wasm
│   ├── lib.rs
│   └── lib.rs.d.ts
├── worker
│   └── index.ts
└── index.html
</code></pre><h3>各種設定ファイル（必要最低限の箇所のみ）</h3><pre class="language-json"><code class="language-json"><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"parcel src/index.html"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"parcel build src/index.html"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"@types/webassembly-js-api"</span><span class="token operator">:</span> <span class="token string">"0.0.3"</span><span class="token punctuation">,</span>
    <span class="token property">"parcel-bundler"</span><span class="token operator">:</span> <span class="token string">"^1.12.3"</span><span class="token punctuation">,</span>
    <span class="token property">"parcel-plugin-wasm.rs"</span><span class="token operator">:</span> <span class="token string">"^1.2.8"</span><span class="token punctuation">,</span>
    <span class="token property">"typescript"</span><span class="token operator">:</span> <span class="token string">"^3.4.2"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"browserslist"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"last 2 chrome versions"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><pre class="language-toml"><code class="language-toml"><span class="token comment"># Cargo.toml</span>
<span class="token punctuation">[</span><span class="token class-name table">package</span><span class="token punctuation">]</span>
<span class="token property key">name</span> <span class="token punctuation">=</span> <span class="token string">"wasm"</span>
<span class="token property key">version</span> <span class="token punctuation">=</span> <span class="token string">"0.1.0"</span>

<span class="token punctuation">[</span><span class="token class-name table">dependencies</span><span class="token punctuation">]</span>
<span class="token property key">wasm-bindgen</span> <span class="token punctuation">=</span> <span class="token string">"^0.2"</span>

<span class="token punctuation">[</span><span class="token class-name table">lib</span><span class="token punctuation">]</span>
<span class="token property key">crate-type</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token class-name table">"cdylib"</span><span class="token punctuation">]</span>
<span class="token property key">path</span> <span class="token punctuation">=</span> <span class="token string">"./src/wasm/lib.rs"</span>
</code></pre><pre class="language-json"><code class="language-json"><span class="token comment">// tsconfig.json</span>
<span class="token punctuation">{</span>
  <span class="token property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"es2015"</span><span class="token punctuation">,</span>
    <span class="token property">"lib"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"es2015"</span><span class="token punctuation">,</span>
      <span class="token string">"dom"</span><span class="token punctuation">,</span>
      <span class="token string">"webworker"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"strict"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"esModuleInterop"</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>WebAssembly未対応のIEを切り捨て、TypeScriptのコンパイルはes2015で行っている。parcelのbabel側でes5に変換されないよう、<code>package.json</code>では<code>browserslist</code>の設定を行う。</p></section><section class="nes-container is-rounded with-title"><h2 class="title">各ファイル</h2><p>全部書くのも面倒なので、各ファイルのインポート部分だけ書いていく。<br>書き足している場所もあるが、全体はサンプルリポジトリを参照。<br><a href="https://github.com/iMasanari/wasm-bindgen-with-worker" rel="noopener" target="_blank">iMasanari/wasm-bindgen-with-worker</a></p><pre class="language-html"><code class="language-html"><span class="token comment">&lt;!-- src/index.html --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app/index.ts<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
</code></pre><pre class="language-typescript"><code class="language-typescript"><span class="token comment">// src/app/index.ts</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'../worker/index.ts'</span><span class="token punctuation">)</span>
</code></pre><pre class="language-typescript"><code class="language-typescript"><span class="token comment">// src/worker/index.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> wasm <span class="token keyword">from</span> <span class="token string">'../wasm/lib.rs'</span>

<span class="token comment">// WebAssemblyの実行</span>
wasm<span class="token punctuation">.</span><span class="token function">some_function</span><span class="token punctuation">(</span><span class="token string">'WebAssembly'</span><span class="token punctuation">)</span>
</code></pre><p>あとは、Rustの関数を作るだけ。<br>現在のWebAssemblyは数値しかやりとりができないが、wasm-bindgenを使うことで文字列やJSONもやりとりができるようになる。</p><pre class="language-rust"><code class="language-rust"><span class="token comment">// src/wasm/lib.rs</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> wasm_bindgen<span class="token punctuation">;</span>
<span class="token keyword">use</span> wasm_bindgen<span class="token punctuation">:</span><span class="token punctuation">:</span>prelude<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token attr-name attribute">#[wasm_bindgen]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">some_function</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&</span>str<span class="token punctuation">)</span> <span class="token punctuation">-></span> String <span class="token punctuation">{</span>
    <span class="token function">format!</span><span class="token punctuation">(</span><span class="token string">"Hello, {}!"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>ビルドも下記コマンドだけでOK。<br>初回だけ、Rustのビルドに時間がかかる。</p><pre class="language-bash"><code class="language-bash"><span class="token comment"># デバッグ用ビルド + サーバー</span>
$ <span class="token function">npm</span> run dev
</code></pre><pre class="language-bash"><code class="language-bash"><span class="token comment"># プロダクションビルド</span>
$ <span class="token function">npm</span> run build
</code></pre><p>出力結果はこんな感じ。<br>なぜか<code>lib.rs</code>まで出力されているが、ちゃんとハッシュが付いているのが確認できる。</p><pre class="language-bash"><code class="language-bash">$ tree dist
dist
├── app.68414551.js
├── index.html
├── lib.3d22fd5b.rs
├── wasm_bg.ead9fc9c.wasm
└── worker.135e8d27.js
</code></pre></section><section class="nes-container is-rounded with-title"><h2 class="title">Webpackとの違い</h2><h3>RustからのJavaScriptコード呼び出しパス</h3><p>Webpackでは、pkgフォルダ内のファイルをインポートするため、相対パスの基準は<code>pkg/</code>である。<br>parcel(parcel-plugin-wasm.rs)では、<code>node_modules/parcel-plugin-wasm.rs/</code>が基準である。parcelの絶対パス（<code>/*</code>）を使えば、エントリーファイルの場所（今回は<code>src/</code>）が基準になる。</p><pre class="language-rust"><code class="language-rust"><span class="token comment">// src/wasm/lib.rs</span>
<span class="token attr-name attribute">#[wasm_bindgen(module = "/worker/wasm-util")]</span>
<span class="token keyword">extern</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">console_log</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3>WebWorker側でのRustインポート</h3><p>Webpackでは、WASMをインポートするまでに必ずDynamic importを挟む必要がある。<br>parcelではその必要がなく、直接importする。（そもそもWebWroker内でのDynamic importがサポートされていない？）</p><p>つまり、parcelではWASMロード中の<code>postMessage</code>を取りこぼしてしまう可能性がある。<br>そのため<a href="https://github.com/iMasanari/wasm-bindgen-with-worker" rel="noopener" target="_blank">サンプル</a>では、<a href="https://github.com/iMasanari/wasm-bindgen-with-worker/blob/master/src/app/wasmWorker.ts#L24" rel="noopener" target="_blank">ロードを待ってからメッセージを送る</a>ようにしている。</p></section><section class="nes-container is-rounded with-title"><h2 class="title">まとめ</h2><p>parcelを使うことで、簡単にWebAssemblyが始められる。</p><p>ちなみにRustは、C言語並みの処理スピードを持ちながらモダンな文法と強力なコンパイル時チェックを備えている言語でおすすめ！　所有権、借用、ライフタイム？　学習コストが高い？　知らんな。一緒に<a href="https://doc.rust-jp.rs/the-rust-programming-language-ja/1.6/book/references-and-borrowing.html#概論" rel="noopener" target="_blank">借用チェッカと戦おうぜ！</a> by Rust初心者</p></section></div></article><div class="PostPager"><div class="PostPager-item"><a href="/blog/use-parcel/">ブログ開発をParcelに変更した</a></div><div class="PostPager-item"><a href="/">HOME</a></div><div class="PostPager-item"><a href="/blog/difference-between-jsx-and-html/">HTMLでは使えないJSX独自の書き方</a></div></div><aside class="nes-container with-title"><div class="title"><span class="AsidePosts-title">同じタグを含む記事</span><ul class="PostTags"><li class="PostTags-li"> <a href="/tags/Rust/" class="PostTags-Link">#Rust</a></li><li class="PostTags-li"> <a href="/tags/wasm-bindgen/" class="PostTags-Link">#wasm-bindgen</a></li><li class="PostTags-li"> <a href="/tags/TypeScript/" class="PostTags-Link">#TypeScript</a></li><li class="PostTags-li"> <a href="/tags/parcel/" class="PostTags-Link">#parcel</a></li></ul></div><ul class="AsidePosts-ul"><li class="AsidePosts-li"><a href="/blog/use-parcel/">ブログ開発をParcelに変更した</a><ul class="PostTags"><li class="PostTags-li"> <a href="/tags/parcel/" class="PostTags-Link">#parcel</a></li></ul></li><li class="AsidePosts-li"><a href="/blog/remove-object-key/">【ES.next】Objectから任意のキーを削除した新しいObjectを作成する</a><ul class="PostTags"><li class="PostTags-li"> <a href="/tags/TypeScript/" class="PostTags-Link">#TypeScript</a></li></ul></li><li class="AsidePosts-li"><a href="/blog/webpacks-rules-in-static-config-js/">React StaticでTypeScriptを使用した時のエラー対処法</a><ul class="PostTags"><li class="PostTags-li"> <a href="/tags/TypeScript/" class="PostTags-Link">#TypeScript</a></li></ul></li><li class="AsidePosts-li"><a href="/blog/use-technology/">ブログで使用した技術</a><ul class="PostTags"><li class="PostTags-li"> <a href="/tags/TypeScript/" class="PostTags-Link">#TypeScript</a></li></ul></li></ul></aside></div></div><footer class="nes-container is-rounded is-dark Footer"><p>Author: <a href="https://github.com/iMasanari">iMasanari</a></p><small><a href="https://github.com/iMasanari/imasanari.github.io/">> Blog Repository &lt;</a></small></footer></div></div><script>var __data={component:1,title:"Rust + wasm-bindgen + WebWorkerの環境構築 - Tech SANDBOX",props:{post:{title:"Rust + wasm-bindgen + WebWorkerの環境構築",description:"WebAssembly Advent Calendar 2018の20日目の記事。",slug:"wasm-bindgen-with-worker",tags:["Rust","wasm-bindgen","TypeScript","parcel"],date:"2018-12-20",update:"2019-04-20T13:15:27.878Z",contents:"<section class='is-rounded nes-container with-title'><p><a href=https://qiita.com/advent-calendar/2018/wasm rel=noopener target=_blank>WebAssembly Advent Calendar 2018</a>の20日目の記事。<br>※ 2019/4/20: 修正</p></section><section class='is-rounded nes-container with-title'><h2 class=title>TL;DR</h2><p>parcelのparcel-plugin-wasm.rsプラグインを使用しよう！</p><p>サンプルリポジトリはこちら<br><a href=https://github.com/iMasanari/wasm-bindgen-with-worker rel=noopener target=_blank>iMasanari/wasm-bindgen-with-worker</a></p></section><section class='is-rounded nes-container with-title'><h2 class=title>やりたいこと</h2><p>時間のかかる処理をWebAssemblyで高速に行いたい。そのためには、下記の条件が必要になる。</p><ul><li>引数や戻り値をJSON形式でやりとりできること</li><li>非同期処理であること</li></ul><p>今回は、Rustでwasm-bindgenを使用し、WebWorker内で動かす環境を作っていく。</p></section><section class='is-rounded nes-container with-title'><h2 class=title>1度、WebPackで構築するも……</h2><p>まずは、<a href=https://www.mizdra.net/entry/2018/10/17/080000 rel=noopener target=_blank>WebAssemblyを使って乱数調整ツールをWebに移植した話</a>を元に、WebPackで構築した。しかし、3つの気になる点が出てきた。</p><ul><li>Worker用のエントリーファイルをもう1つ用意しなければならない<ul><li><a href=https://github.com/webpack/webpack/issues/7647 rel=noopener target=_blank>Cannot import wasm in web workers #7647</a></li></ul></li><li>中間ファイル生成（Rust→wasm）のせいで、ビルドタスクが煩雑になる</li><li>ライブリロード<ul><li>ワンテンポ遅いタイミングでページ全体のリロードがされる</li><li>リロードの読み込み時間も長い</li></ul></li></ul><p>エントリーファイルの問題は、WebWorkerのファイル名にハッシュ（<code>worker.2290ab9e.js</code>の<code>2290ab9e</code>部分）が付けられないことである。今回はスクリプトがView、WebWorker、WASMの3ファイルに分かれるので、キャッシュ対策のためにも必要度は高い。</p></section><section class='is-rounded nes-container with-title'><h2 class=title>parcelでの環境構築</h2><p>Webpackで環境を作って数日後、ふと別のモジュールバンドラを使用すればよいのではと思い、parcelで試してみた。すると、上記のエントリーファイル問題、中間ファイル問題を解決することができた。<br>ライブリロードの件は一応差分更新を試みてくれるが、Rustの更新内容は反映されなかった。ただ、普段ライブリロードは使わず、またワンテンポ遅れの全リロードでないためそこまで問題は感じていない。</p><p>なぜ最初にparcelで試さなかったのかというと、情報がWebpackのものしかなかったからだ。なので今回、parcelでWebWorker + WebAssemblyを扱う方法を共有したい。（といっても、parcelがゼロコンフィグなモジュールバンドラのため、そこまで凝ったことはしていない）</p></section><section class='is-rounded nes-container with-title'><h2 class=title>各種インストール</h2><p>Node.jsやRustはインストール済みとする。</p><p>parcelのインストール</p><p><del>parcel-plugin-wasm.rs v1.2.7はparcel-bundler v1.11.0に対応していないのかビルドエラーになったため、バージョンを指定してインストールしている。</del> ※最新バージョンで治っていることを確認。</p><pre class=language-bash><code class=language-bash>$ <span class='token function'>npm</span> <span class='token function'>install</span> -D parcel-bundler parcel-plugin-wasm.rs\n</code></pre><p>parcel-plugin-wasm.rsはRustをwasm-packでコンパイルするためのparcelのプラグイン。wasm-packのインストールがまだの場合はインストールする。</p><pre class=language-bash><code class=language-bash>$ cargo <span class='token function'>install</span> wasm-pack\n</code></pre><p>個人的にいつもTypeScriptを使うので、それ関連のインストール。<br><a href=https://www.npmjs.com/package/@types/webassembly-js-api rel=noopener target=_blank>@types/webassembly-js-api</a>は、WebAssemblyの型定義。</p><pre class=language-bash><code class=language-bash>$ <span class='token function'>npm</span> <span class='token function'>install</span> -D typescript @types/webassembly-js-api\n</code></pre></section><section class='is-rounded nes-container with-title'><h2 class=title>フォルダ構成と設定ファイル</h2><h3>フォルダ構成（srcフォルダ）</h3><p>各種フォルダとエントリーポイントのHTMLという構成で、個人的にすごくきれいな配置だと思う。<br>ちなみにこの出力をするためにMacへTreeコマンドを入れた。</p><pre class=language-bash><code class=language-bash>$ tree src\nsrc\n├── app\n│   └── index.ts\n├── wasm\n│   ├── lib.rs\n│   └── lib.rs.d.ts\n├── worker\n│   └── index.ts\n└── index.html\n</code></pre><h3>各種設定ファイル（必要最低限の箇所のみ）</h3><pre class=language-json><code class=language-json><span class='token comment'>// package.json</span>\n<span class='token punctuation'>{</span>\n  <span class='token property'>\"scripts\"</span><span class='token operator'>:</span> <span class='token punctuation'>{</span>\n    <span class='token property'>\"dev\"</span><span class='token operator'>:</span> <span class='token string'>\"parcel src/index.html\"</span><span class='token punctuation'>,</span>\n    <span class='token property'>\"build\"</span><span class='token operator'>:</span> <span class='token string'>\"parcel build src/index.html\"</span><span class='token punctuation'>,</span>\n  <span class='token punctuation'>}</span><span class='token punctuation'>,</span>\n  <span class='token property'>\"devDependencies\"</span><span class='token operator'>:</span> <span class='token punctuation'>{</span>\n    <span class='token property'>\"@types/webassembly-js-api\"</span><span class='token operator'>:</span> <span class='token string'>\"0.0.3\"</span><span class='token punctuation'>,</span>\n    <span class='token property'>\"parcel-bundler\"</span><span class='token operator'>:</span> <span class='token string'>\"^1.12.3\"</span><span class='token punctuation'>,</span>\n    <span class='token property'>\"parcel-plugin-wasm.rs\"</span><span class='token operator'>:</span> <span class='token string'>\"^1.2.8\"</span><span class='token punctuation'>,</span>\n    <span class='token property'>\"typescript\"</span><span class='token operator'>:</span> <span class='token string'>\"^3.4.2\"</span>\n  <span class='token punctuation'>}</span><span class='token punctuation'>,</span>\n  <span class='token property'>\"browserslist\"</span><span class='token operator'>:</span> <span class='token punctuation'>[</span>\n    <span class='token string'>\"last 2 chrome versions\"</span>\n  <span class='token punctuation'>]</span>\n<span class='token punctuation'>}</span>\n</code></pre><pre class=language-toml><code class=language-toml><span class='token comment'># Cargo.toml</span>\n<span class='token punctuation'>[</span><span class='token class-name table'>package</span><span class='token punctuation'>]</span>\n<span class='token property key'>name</span> <span class='token punctuation'>=</span> <span class='token string'>\"wasm\"</span>\n<span class='token property key'>version</span> <span class='token punctuation'>=</span> <span class='token string'>\"0.1.0\"</span>\n\n<span class='token punctuation'>[</span><span class='token class-name table'>dependencies</span><span class='token punctuation'>]</span>\n<span class='token property key'>wasm-bindgen</span> <span class='token punctuation'>=</span> <span class='token string'>\"^0.2\"</span>\n\n<span class='token punctuation'>[</span><span class='token class-name table'>lib</span><span class='token punctuation'>]</span>\n<span class='token property key'>crate-type</span> <span class='token punctuation'>=</span> <span class='token punctuation'>[</span><span class='token class-name table'>\"cdylib\"</span><span class='token punctuation'>]</span>\n<span class='token property key'>path</span> <span class='token punctuation'>=</span> <span class='token string'>\"./src/wasm/lib.rs\"</span>\n</code></pre><pre class=language-json><code class=language-json><span class='token comment'>// tsconfig.json</span>\n<span class='token punctuation'>{</span>\n  <span class='token property'>\"compilerOptions\"</span><span class='token operator'>:</span> <span class='token punctuation'>{</span>\n    <span class='token property'>\"target\"</span><span class='token operator'>:</span> <span class='token string'>\"es2015\"</span><span class='token punctuation'>,</span>\n    <span class='token property'>\"lib\"</span><span class='token operator'>:</span> <span class='token punctuation'>[</span>\n      <span class='token string'>\"es2015\"</span><span class='token punctuation'>,</span>\n      <span class='token string'>\"dom\"</span><span class='token punctuation'>,</span>\n      <span class='token string'>\"webworker\"</span>\n    <span class='token punctuation'>]</span><span class='token punctuation'>,</span>\n    <span class='token property'>\"strict\"</span><span class='token operator'>:</span> <span class='token boolean'>true</span><span class='token punctuation'>,</span>\n    <span class='token property'>\"esModuleInterop\"</span><span class='token operator'>:</span> <span class='token boolean'>true</span>\n  <span class='token punctuation'>}</span>\n<span class='token punctuation'>}</span>\n</code></pre><p>WebAssembly未対応のIEを切り捨て、TypeScriptのコンパイルはes2015で行っている。parcelのbabel側でes5に変換されないよう、<code>package.json</code>では<code>browserslist</code>の設定を行う。</p></section><section class='is-rounded nes-container with-title'><h2 class=title>各ファイル</h2><p>全部書くのも面倒なので、各ファイルのインポート部分だけ書いていく。<br>書き足している場所もあるが、全体はサンプルリポジトリを参照。<br><a href=https://github.com/iMasanari/wasm-bindgen-with-worker rel=noopener target=_blank>iMasanari/wasm-bindgen-with-worker</a></p><pre class=language-html><code class=language-html><span class='token comment'>&lt;!-- src/index.html --\x3e</span>\n<span class='token tag'><span class='token tag'><span class='token punctuation'>&lt;</span>script</span> <span class='token attr-name'>src</span><span class='token attr-value'><span class='token punctuation'>=</span><span class='token punctuation'>\"</span>app/index.ts<span class='token punctuation'>\"</span></span><span class='token punctuation'>></span></span><span class='token script'></span><span class='token tag'><span class='token tag'><span class='token punctuation'>&lt;/</span>script</span><span class='token punctuation'>></span></span>\n</code></pre><pre class=language-typescript><code class=language-typescript><span class='token comment'>// src/app/index.ts</span>\n<span class='token keyword'>const</span> worker <span class='token operator'>=</span> <span class='token keyword'>new</span> <span class='token class-name'>Worker</span><span class='token punctuation'>(</span><span class='token string'>'../worker/index.ts'</span><span class='token punctuation'>)</span>\n</code></pre><pre class=language-typescript><code class=language-typescript><span class='token comment'>// src/worker/index.ts</span>\n<span class='token keyword'>import</span> <span class='token operator'>*</span> <span class='token keyword'>as</span> wasm <span class='token keyword'>from</span> <span class='token string'>'../wasm/lib.rs'</span>\n\n<span class='token comment'>// WebAssemblyの実行</span>\nwasm<span class='token punctuation'>.</span><span class='token function'>some_function</span><span class='token punctuation'>(</span><span class='token string'>'WebAssembly'</span><span class='token punctuation'>)</span>\n</code></pre><p>あとは、Rustの関数を作るだけ。<br>現在のWebAssemblyは数値しかやりとりができないが、wasm-bindgenを使うことで文字列やJSONもやりとりができるようになる。</p><pre class=language-rust><code class=language-rust><span class='token comment'>// src/wasm/lib.rs</span>\n<span class='token keyword'>extern</span> <span class='token keyword'>crate</span> wasm_bindgen<span class='token punctuation'>;</span>\n<span class='token keyword'>use</span> wasm_bindgen<span class='token punctuation'>:</span><span class='token punctuation'>:</span>prelude<span class='token punctuation'>:</span><span class='token punctuation'>:</span><span class='token operator'>*</span><span class='token punctuation'>;</span>\n\n<span class='token attr-name attribute'>#[wasm_bindgen]</span>\n<span class='token keyword'>pub</span> <span class='token keyword'>fn</span> <span class='token function'>some_function</span><span class='token punctuation'>(</span>input<span class='token punctuation'>:</span> <span class='token operator'>&amp;</span>str<span class='token punctuation'>)</span> <span class='token punctuation'>-></span> String <span class='token punctuation'>{</span>\n    <span class='token function'>format!</span><span class='token punctuation'>(</span><span class='token string'>\"Hello, {}!\"</span><span class='token punctuation'>,</span> input<span class='token punctuation'>)</span>\n<span class='token punctuation'>}</span>\n</code></pre><p>ビルドも下記コマンドだけでOK。<br>初回だけ、Rustのビルドに時間がかかる。</p><pre class=language-bash><code class=language-bash><span class='token comment'># デバッグ用ビルド + サーバー</span>\n$ <span class='token function'>npm</span> run dev\n</code></pre><pre class=language-bash><code class=language-bash><span class='token comment'># プロダクションビルド</span>\n$ <span class='token function'>npm</span> run build\n</code></pre><p>出力結果はこんな感じ。<br>なぜか<code>lib.rs</code>まで出力されているが、ちゃんとハッシュが付いているのが確認できる。</p><pre class=language-bash><code class=language-bash>$ tree dist\ndist\n├── app.68414551.js\n├── index.html\n├── lib.3d22fd5b.rs\n├── wasm_bg.ead9fc9c.wasm\n└── worker.135e8d27.js\n</code></pre></section><section class='is-rounded nes-container with-title'><h2 class=title>Webpackとの違い</h2><h3>RustからのJavaScriptコード呼び出しパス</h3><p>Webpackでは、pkgフォルダ内のファイルをインポートするため、相対パスの基準は<code>pkg/</code>である。<br>parcel(parcel-plugin-wasm.rs)では、<code>node_modules/parcel-plugin-wasm.rs/</code>が基準である。parcelの絶対パス（<code>/*</code>）を使えば、エントリーファイルの場所（今回は<code>src/</code>）が基準になる。</p><pre class=language-rust><code class=language-rust><span class='token comment'>// src/wasm/lib.rs</span>\n<span class='token attr-name attribute'>#[wasm_bindgen(module = \"/worker/wasm-util\")]</span>\n<span class='token keyword'>extern</span> <span class='token punctuation'>{</span>\n    <span class='token keyword'>fn</span> <span class='token function'>console_log</span><span class='token punctuation'>(</span>s<span class='token punctuation'>:</span> <span class='token operator'>&amp;</span>str<span class='token punctuation'>)</span><span class='token punctuation'>;</span>\n<span class='token punctuation'>}</span>\n</code></pre><h3>WebWorker側でのRustインポート</h3><p>Webpackでは、WASMをインポートするまでに必ずDynamic importを挟む必要がある。<br>parcelではその必要がなく、直接importする。（そもそもWebWroker内でのDynamic importがサポートされていない？）</p><p>つまり、parcelではWASMロード中の<code>postMessage</code>を取りこぼしてしまう可能性がある。<br>そのため<a href=https://github.com/iMasanari/wasm-bindgen-with-worker rel=noopener target=_blank>サンプル</a>では、<a href=https://github.com/iMasanari/wasm-bindgen-with-worker/blob/master/src/app/wasmWorker.ts#L24 rel=noopener target=_blank>ロードを待ってからメッセージを送る</a>ようにしている。</p></section><section class='is-rounded nes-container with-title'><h2 class=title>まとめ</h2><p>parcelを使うことで、簡単にWebAssemblyが始められる。</p><p>ちなみにRustは、C言語並みの処理スピードを持ちながらモダンな文法と強力なコンパイル時チェックを備えている言語でおすすめ！　所有権、借用、ライフタイム？　学習コストが高い？　知らんな。一緒に<a href=https://doc.rust-jp.rs/the-rust-programming-language-ja/1.6/book/references-and-borrowing.html#概論 rel=noopener target=_blank>借用チェッカと戦おうぜ！</a> by Rust初心者</p></section>"},prev:{title:"ブログ開発をParcelに変更した",slug:"use-parcel"},next:{title:"HTMLでは使えないJSX独自の書き方",slug:"difference-between-jsx-and-html"},sameTags:[{title:"ブログ開発をParcelに変更した",slug:"use-parcel",date:"2019-04-26",tags:["parcel","blog"]},{title:"【ES.next】Objectから任意のキーを削除した新しいObjectを作成する",slug:"remove-object-key",date:"2018-07-13",tags:["JavaScript","Babel","TypeScript"]},{title:"React StaticでTypeScriptを使用した時のエラー対処法",slug:"webpacks-rules-in-static-config-js",date:"2018-07-03",tags:["ReactStatic","TypeScript","webpack"]},{title:"ブログで使用した技術",slug:"use-technology",date:"2018-06-30",tags:["blog","React","preact","TypeScript","ReactStatic"]}]}}</script> <script src="/src.9be82b6d.js"></script>
</body></html>