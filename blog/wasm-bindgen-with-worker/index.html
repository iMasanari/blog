<!DOCTYPE html><html lang="ja"><head><meta charSet="utf-8" /><meta name="viewport" content="width=device-width" /><title>Rust + wasm-bindgen + WebWorkerの環境構築 | Tech SANDBOX</title><meta name="description" content="WebAssembly Advent Calendar 2018の20日目の記事。" /><meta property="og:title" content="Rust + wasm-bindgen + WebWorkerの環境構築 | Tech SANDBOX" /><meta property="og:description" content="WebAssembly Advent Calendar 2018の20日目の記事。" /><meta property="og:type" content="article" /><meta property="og:url" content="https://blog.imasanari.dev/blog/wasm-bindgen-with-worker/" /><meta property="og:image" content="https://blog.imasanari.dev/images/icon.jpg" /><meta property="og:site_name" content="Tech SANDBOX" /><meta name="twitter:card" content="summary" /><meta name="next-head-count" content="11" /><meta charSet="utf-8" /><script async src="https://www.googletagmanager.com/gtag/js?id=UA-74494516-4"></script><script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'UA-74494516-4', {
  page_path: window.location.pathname,
});
</script><meta name="google-site-verification" content="UmWq3FQLg72H6H0Tlk-SFR9f0bSBsvC8nDmxtK3-qMc" /><meta name="next-font-preconnect" /><link rel="amphtml" href="/blog/wasm-bindgen-with-worker.amp" /><noscript data-n-css></noscript><script defer noModule src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer></script><script src="/_next/static/chunks/framework-da30cb0cd7d038e7.js" defer></script><script src="/_next/static/chunks/main-9fc370467ffab28e.js" defer></script><script src="/_next/static/chunks/pages/_app-d26166b7d1ee9cd4.js" defer></script><script src="/_next/static/chunks/510-ac06f49b3eddcc17.js" defer></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-a8fd25f25c4a7a36.js" defer></script><script src="/_next/static/sshnfDrKevPjfNC6WQ_tP/_buildManifest.js" defer></script><script src="/_next/static/sshnfDrKevPjfNC6WQ_tP/_ssgManifest.js" defer></script><style data-emotion="c-global 15yblv4">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:1rem;line-height:1.5;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="c 1kyvigp 1ghlunn i9gxme 1x6wkub 1tqdl5x wb6uyc rntpfg 3zeruj zjuml4 1dmadst vubbuv i6s8oy 1qsxih2 1yjvs5a 1n6wxgb 1qh3bxa 16n8wpk 9txlqf 1ihubty ntfpy7 1vaygba 1f5kc47 y25xid 15kjgm 1ugattu 5ck7xs 1lky7cb 1f8td17 ceho3e 14rm9aa vlahzl 1yipi07 1k33q06 12ogyw6 15x2j1y 1aue7hj 1sl6rns f7hjxq 1bhrv1p mpp38z ze4krk 1jnynlu 1rvtlej 116qoqd 1d3ah2d fnf71d 19fxvs2">.c-1kyvigp{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;box-shadow:0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:fixed;z-index:1100;top:0;left:auto;right:0;background-color:#f5f5f5;color:rgba(0, 0, 0, 0.87);overflow:hidden;}@media print{.c-1kyvigp{position:absolute;}}.c-1ghlunn{width:100%;margin-left:auto;box-sizing:border-box;margin-right:auto;display:block;padding-left:16px;padding-right:16px;position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;min-height:56px;}@media (min-width:600px){.c-1ghlunn{padding-left:24px;padding-right:24px;}}@media (min-width:1200px){.c-1ghlunn{max-width:1200px;}}@media (min-width:0px){@media (orientation: landscape){.c-1ghlunn{min-height:48px;}}}@media (min-width:600px){.c-1ghlunn{min-height:64px;}}.c-i9gxme{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}.c-1x6wkub{margin:0;font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:1.25rem;line-height:1.6;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}.c-1tqdl5x{margin:0;color:inherit;-webkit-text-decoration:none;text-decoration:none;color:inherit;}.c-wb6uyc{margin:0;font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:0.875rem;line-height:1.43;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}@media (min-width:0px){.c-rntpfg{display:none;}}@media (min-width:600px){.c-rntpfg{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.c-3zeruj{margin:0;font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:1rem;line-height:1.5;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:inherit;margin-left:24px;-webkit-text-decoration:underline;text-decoration:underline;color:inherit;}.c-3zeruj:hover{text-decoration-color:inherit;}@media (min-width:0px){.c-zjuml4{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}@media (min-width:600px){.c-zjuml4{display:none;}}.c-1dmadst{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;text-align:center;-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;font-size:1.5rem;padding:8px;border-radius:50%;overflow:visible;color:rgba(0, 0, 0, 0.54);-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;margin-right:-12px;color:inherit;padding:12px;font-size:1.75rem;}.c-1dmadst::-moz-focus-inner{border-style:none;}.c-1dmadst.Mui-disabled{pointer-events:none;cursor:default;}@media print{.c-1dmadst{-webkit-print-color-adjust:exact;color-adjust:exact;}}.c-1dmadst:hover{background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.c-1dmadst:hover{background-color:transparent;}}.c-1dmadst.Mui-disabled{background-color:transparent;color:rgba(0, 0, 0, 0.26);}.c-vubbuv{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;}.c-i6s8oy{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding-left:16px;padding-right:16px;min-height:56px;}@media (min-width:600px){.c-i6s8oy{padding-left:24px;padding-right:24px;}}@media (min-width:0px){@media (orientation: landscape){.c-i6s8oy{min-height:48px;}}}@media (min-width:600px){.c-i6s8oy{min-height:64px;}}.c-1qsxih2{width:100%;margin-left:auto;box-sizing:border-box;margin-right:auto;display:block;padding-left:16px;padding-right:16px;}@media (min-width:600px){.c-1qsxih2{padding-left:24px;padding-right:24px;}}@media (min-width:1200px){.c-1qsxih2{max-width:1200px;}}.c-1yjvs5a{margin-bottom:32px;}.c-1n6wxgb{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:8px 0px;}.c-1qh3bxa{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.25rem;margin-right:4px;}.c-16n8wpk{margin:0;font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:0.875rem;line-height:1.43;}.c-9txlqf{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.25rem;margin-left:16px;margin-right:4px;}.c-1ihubty{margin:0;font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:1.5rem;line-height:1.334;margin-bottom:0.35em;}.c-ntfpy7{padding:0;margin:0;}.c-1vaygba{display:inline;padding:0;margin:0;}.c-1f5kc47{margin:0;color:rgba(0, 0, 0, 0.6);-webkit-text-decoration:none;text-decoration:none;}.c-1f5kc47:hover{-webkit-text-decoration:underline;text-decoration:underline;}.c-y25xid{margin:0;font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:1rem;line-height:1.5;margin-top:16px;margin-bottom:16px;text-align:justify;white-space:pre-line;}.c-15kjgm{margin:0;color:#1976d2;-webkit-text-decoration:underline;text-decoration:underline;text-decoration-color:rgba(25, 118, 210, 0.4);}.c-15kjgm:hover{text-decoration-color:inherit;}.c-1ugattu{margin:0;font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:2.125rem;line-height:1.235;margin-top:32px;margin-bottom:32px;border-bottom:1px solid currentcolor;}.c-5ck7xs{margin:0;font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:1rem;line-height:1.5;margin-top:16px;margin-bottom:16px;}.c-5ck7xs .c-5ck7xs{margin-top:0;margin-bottom:0;}.c-1lky7cb{margin:0;font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:1rem;line-height:1.5;}.c-1f8td17{padding:4px 8px;border-radius:4px;background-color:#1e1e1e;color:#d4d4d4;font-family:"SFMono-Regular",Consolas,Menlo,Courier,monospace,monospace;font-size:0.9em;word-break:break-all;}pre>.c-1f8td17{padding:0;background-color:transparent;}.c-ceho3e{padding:4px 8px;border-radius:4px;background-color:#1e1e1e;color:#d4d4d4;font-family:"SFMono-Regular",Consolas,Menlo,Courier,monospace,monospace;font-size:0.9em;}pre>.c-ceho3e{padding:0;background-color:transparent;}.c-14rm9aa{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;border-radius:4px;box-shadow:0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12);margin-top:16px;margin-bottom:16px;}.c-vlahzl{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:4px 32px;border-top-right-radius:5px;border-top-left-radius:5px;background-color:#555;color:white;}.c-1yipi07{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;text-align:center;-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;font-size:1.5rem;padding:8px;border-radius:50%;overflow:visible;color:rgba(0, 0, 0, 0.54);-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;padding:5px;font-size:1.125rem;color:white;}.c-1yipi07::-moz-focus-inner{border-style:none;}.c-1yipi07.Mui-disabled{pointer-events:none;cursor:default;}@media print{.c-1yipi07{-webkit-print-color-adjust:exact;color-adjust:exact;}}.c-1yipi07:hover{background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.c-1yipi07:hover{background-color:transparent;}}.c-1yipi07.Mui-disabled{background-color:transparent;color:rgba(0, 0, 0, 0.26);}.c-1k33q06{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.25rem;}.c-12ogyw6{margin:0;font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:1rem;line-height:1.5;overflow:auto;padding:8px 32px;border-bottom-right-radius:5px;border-bottom-left-radius:5px;}.c-15x2j1y{margin:0;font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:1.5rem;line-height:1.334;margin-top:24px;margin-bottom:24px;}.c-1aue7hj{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding:0;margin:32px 0px;}.c-1sl6rns{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:8px 16px;margin:0;-webkit-flex:1;-ms-flex:1;flex:1;padding-left:0;-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;}.c-f7hjxq{margin:0;font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:1rem;line-height:1.5;color:#1976d2;-webkit-text-decoration:underline;text-decoration:underline;text-decoration-color:rgba(25, 118, 210, 0.4);}.c-f7hjxq:hover{text-decoration-color:inherit;}.c-1bhrv1p{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:8px 16px;margin:0;border-left:1px solid #6c6c6c;border-right:1px solid #6c6c6c;}.c-mpp38z{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:8px 16px;margin:0;-webkit-flex:1;-ms-flex:1;flex:1;padding-right:0;}.c-ze4krk{margin:32px auto;}.c-1jnynlu{margin:0;font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:1.5rem;line-height:1.334;}.c-1rvtlej{list-style:none;padding:0;margin:0;}.c-116qoqd{padding:16px 24px;margin:16px 0px;border:1px solid #bbb;}.c-1d3ah2d{text-align:center;margin:32px 0px;}.c-fnf71d{margin:0;font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:1rem;line-height:1.5;margin-bottom:0.35em;}.c-19fxvs2{margin:0;font-family:游ゴシック体,YuGothic,游ゴシック,Yu Gothic,メイリオ,sans-serif;font-weight:500;font-size:0.875rem;line-height:1.43;color:#1976d2;-webkit-text-decoration:underline;text-decoration:underline;text-decoration-color:rgba(25, 118, 210, 0.4);}.c-19fxvs2:hover{text-decoration-color:inherit;}</style></head><body><div id="__next"><header amp-fx="float-in-top" class="MuiPaper-root MuiPaper-elevation MuiPaper-elevation1 MuiAppBar-root MuiAppBar-colorDefault MuiAppBar-positionFixed mui-fixed c-1kyvigp"><div class="MuiContainer-root MuiContainer-maxWidthLg MuiToolbar-root MuiToolbar-regular c-1ghlunn"><div class="c-i9gxme"><div class="MuiTypography-root MuiTypography-h6 MuiTypography-noWrap c-1x6wkub"><a href="/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineNone c-1tqdl5x">Tech SANDBOX</a></div><p class="MuiTypography-root MuiTypography-body2 MuiTypography-noWrap c-wb6uyc">技術ブログ改め、Qiitaの下書き</p></div><nav class="MuiBox-root c-rntpfg"><a href="/" class="MuiTypography-root MuiTypography-body1 MuiTypography-noWrap MuiLink-root MuiLink-underlineAlways c-3zeruj">Blog</a><a href="https://github.com/iMasanari" target="_blank" rel="noopener" class="MuiTypography-root MuiTypography-body1 MuiTypography-noWrap MuiLink-root MuiLink-underlineAlways c-3zeruj">GitHub</a><a href="https://qiita.com/iMasanari" target="_blank" rel="noopener" class="MuiTypography-root MuiTypography-body1 MuiTypography-noWrap MuiLink-root MuiLink-underlineAlways c-3zeruj">Qiita</a></nav><div class="MuiBox-root c-zjuml4"><button tabIndex="0" type="button" aria-label="menu" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-colorInherit MuiIconButton-edgeEnd MuiIconButton-sizeLarge c-1dmadst"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="MenuIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium c-vubbuv"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></button></div></div></header><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular c-i6s8oy"></div><div class="MuiContainer-root MuiContainer-maxWidthLg c-1qsxih2"><article><div class="MuiBox-root c-1yjvs5a"><header><div class="c-1n6wxgb"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="CalendarTodayIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1qh3bxa"><path d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13z"></path></svg><time dateTime="2018-12-20T14:58:37.388Z" class="MuiTypography-root MuiTypography-body2 c-16n8wpk">2018-12-20</time><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="SyncIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-9txlqf"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"></path></svg><time dateTime="2019-04-20T13:15:27.878Z" class="MuiTypography-root MuiTypography-body2 c-16n8wpk">2019-04-20</time></div><h1 class="MuiTypography-root MuiTypography-h5 MuiTypography-gutterBottom c-1ihubty">Rust + wasm-bindgen + WebWorkerの環境構築</h1><ul class="c-ntfpy7"> <li class="c-1vaygba"><a href="/tags/Rust/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#Rust</a></li> <li class="c-1vaygba"><a href="/tags/wasm-bindgen/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#wasm-bindgen</a></li> <li class="c-1vaygba"><a href="/tags/TypeScript/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#TypeScript</a></li> <li class="c-1vaygba"><a href="/tags/parcel/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#parcel</a></li></ul></header></div><main><p class="MuiTypography-root MuiTypography-body1 c-y25xid"><a href="https://qiita.com/advent-calendar/2018/wasm" target="_blank" rel="noopener" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways c-15kjgm">WebAssembly Advent Calendar 2018</a>の20日目の記事。
※ 2019/4/20: 修正</p>
<h2 class="MuiTypography-root MuiTypography-h4 c-1ugattu">TL;DR</h2>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">parcelのparcel-plugin-wasm.rsプラグインを使用しよう！</p>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">サンプルリポジトリはこちら
<a href="https://github.com/iMasanari/wasm-bindgen-with-worker" target="_blank" rel="noopener" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways c-15kjgm">iMasanari/wasm-bindgen-with-worker</a></p>
<h2 class="MuiTypography-root MuiTypography-h4 c-1ugattu">やりたいこと</h2>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">時間のかかる処理をWebAssemblyで高速に行いたい。そのためには、下記の条件が必要になる。</p>
<ul class="MuiTypography-root MuiTypography-body1 c-5ck7xs">
<li class="MuiTypography-root MuiTypography-body1 c-1lky7cb">引数や戻り値をJSON形式でやりとりできること</li>
<li class="MuiTypography-root MuiTypography-body1 c-1lky7cb">非同期処理であること</li>
</ul>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">今回は、Rustでwasm-bindgenを使用し、WebWorker内で動かす環境を作っていく。</p>
<h2 class="MuiTypography-root MuiTypography-h4 c-1ugattu">1度、WebPackで構築するも……</h2>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">まずは、<a href="https://www.mizdra.net/entry/2018/10/17/080000" target="_blank" rel="noopener" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways c-15kjgm">WebAssemblyを使って乱数調整ツールをWebに移植した話</a>を元に、WebPackで構築した。しかし、3つの気になる点が出てきた。</p>
<ul class="MuiTypography-root MuiTypography-body1 c-5ck7xs">
<li class="MuiTypography-root MuiTypography-body1 c-1lky7cb">Worker用のエントリーファイルをもう1つ用意しなければならない
<ul class="MuiTypography-root MuiTypography-body1 c-5ck7xs">
<li class="MuiTypography-root MuiTypography-body1 c-1lky7cb"><a href="https://github.com/webpack/webpack/issues/7647" target="_blank" rel="noopener" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways c-15kjgm">Cannot import wasm in web workers #7647</a></li>
</ul>
</li>
<li class="MuiTypography-root MuiTypography-body1 c-1lky7cb">中間ファイル生成（Rust→wasm）のせいで、ビルドタスクが煩雑になる</li>
<li class="MuiTypography-root MuiTypography-body1 c-1lky7cb">ライブリロード
<ul class="MuiTypography-root MuiTypography-body1 c-5ck7xs">
<li class="MuiTypography-root MuiTypography-body1 c-1lky7cb">ワンテンポ遅いタイミングでページ全体のリロードがされる</li>
<li class="MuiTypography-root MuiTypography-body1 c-1lky7cb">リロードの読み込み時間も長い</li>
</ul>
</li>
</ul>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">エントリーファイルの問題は、WebWorkerのファイル名にハッシュ（<code class="c-1f8td17">worker.2290ab9e.js</code>の<code class="c-ceho3e">2290ab9e</code>部分）が付けられないことである。今回はスクリプトがView、WebWorker、WASMの3ファイルに分かれるので、キャッシュ対策のためにも必要度は高い。</p>
<h2 class="MuiTypography-root MuiTypography-h4 c-1ugattu">parcelでの環境構築</h2>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">Webpackで環境を作って数日後、ふと別のモジュールバンドラを使用すればよいのではと思い、parcelで試してみた。すると、上記のエントリーファイル問題、中間ファイル問題を解決することができた。
ライブリロードの件は一応差分更新を試みてくれるが、Rustの更新内容は反映されなかった。ただ、普段ライブリロードは使わず、またワンテンポ遅れの全リロードでないためそこまで問題は感じていない。</p>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">なぜ最初にparcelで試さなかったのかというと、情報がWebpackのものしかなかったからだ。なので今回、parcelでWebWorker + WebAssemblyを扱う方法を共有したい。（といっても、parcelがゼロコンフィグなモジュールバンドラのため、そこまで凝ったことはしていない）</p>
<h2 class="MuiTypography-root MuiTypography-h4 c-1ugattu">各種インストール</h2>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">Node.jsやRustはインストール済みとする。</p>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">parcelのインストール</p>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid"><del>parcel-plugin-wasm.rs v1.2.7はparcel-bundler v1.11.0に対応していないのかビルドエラーになったため、バージョンを指定してインストールしている。</del></p>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">※最新バージョンで治っていることを確認。</p>
<div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 c-14rm9aa"><div class="c-vlahzl"><span class="MuiTypography-root MuiTypography-body1 c-1lky7cb"></span><button tabIndex="0" type="button" aria-label="copy" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall c-1yipi07"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ContentCopyIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1k33q06"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button></div><pre style="background-color: #1E1E1E;" class="MuiTypography-root MuiTypography-body1 shiki c-12ogyw6"><code class="c-ceho3e"><span class="line"><span style="color: #D4D4D4;">$ npm install -D parcel-bundler parcel-plugin-wasm.rs</span></span></code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">parcel-plugin-wasm.rsはRustをwasm-packでコンパイルするためのparcelのプラグイン。wasm-packのインストールがまだの場合はインストールする。</p>
<div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 c-14rm9aa"><div class="c-vlahzl"><span class="MuiTypography-root MuiTypography-body1 c-1lky7cb"></span><button tabIndex="0" type="button" aria-label="copy" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall c-1yipi07"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ContentCopyIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1k33q06"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button></div><pre style="background-color: #1E1E1E;" class="MuiTypography-root MuiTypography-body1 shiki c-12ogyw6"><code class="c-ceho3e"><span class="line"><span style="color: #D4D4D4;">$ cargo install wasm-pack</span></span></code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">個人的にいつもTypeScriptを使うので、それ関連のインストール。
<a href="https://www.npmjs.com/package/@types/webassembly-js-api" target="_blank" rel="noopener" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways c-15kjgm">@types/webassembly-js-api</a>は、WebAssemblyの型定義。</p>
<div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 c-14rm9aa"><div class="c-vlahzl"><span class="MuiTypography-root MuiTypography-body1 c-1lky7cb"></span><button tabIndex="0" type="button" aria-label="copy" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall c-1yipi07"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ContentCopyIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1k33q06"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button></div><pre style="background-color: #1E1E1E;" class="MuiTypography-root MuiTypography-body1 shiki c-12ogyw6"><code class="c-ceho3e"><span class="line"><span style="color: #D4D4D4;">$ npm install -D typescript @types/webassembly-js-api</span></span></code></pre></div>
<h2 class="MuiTypography-root MuiTypography-h4 c-1ugattu">フォルダ構成と設定ファイル</h2>
<h3 class="MuiTypography-root MuiTypography-h5 c-15x2j1y">フォルダ構成（srcフォルダ）</h3>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">各種フォルダとエントリーポイントのHTMLという構成で、個人的にすごくきれいな配置だと思う。
ちなみにこの出力をするためにMacへTreeコマンドを入れた。</p>
<div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 c-14rm9aa"><div class="c-vlahzl"><span class="MuiTypography-root MuiTypography-body1 c-1lky7cb"></span><button tabIndex="0" type="button" aria-label="copy" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall c-1yipi07"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ContentCopyIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1k33q06"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button></div><pre style="background-color: #1E1E1E;" class="MuiTypography-root MuiTypography-body1 shiki c-12ogyw6"><code class="c-ceho3e"><span class="line"><span style="color: #D4D4D4;">$ tree src</span></span>
<span class="line"><span style="color: #D4D4D4;">src</span></span>
<span class="line"><span style="color: #D4D4D4;">├── app</span></span>
<span class="line"><span style="color: #D4D4D4;">│   └── index.ts</span></span>
<span class="line"><span style="color: #D4D4D4;">├── wasm</span></span>
<span class="line"><span style="color: #D4D4D4;">│   ├── lib.rs</span></span>
<span class="line"><span style="color: #D4D4D4;">│   └── lib.rs.d.ts</span></span>
<span class="line"><span style="color: #D4D4D4;">├── worker</span></span>
<span class="line"><span style="color: #D4D4D4;">│   └── index.ts</span></span>
<span class="line"><span style="color: #D4D4D4;">└── index.html</span></span></code></pre></div>
<h3 class="MuiTypography-root MuiTypography-h5 c-15x2j1y">各種設定ファイル（必要最低限の箇所のみ）</h3>
<div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 c-14rm9aa"><div class="c-vlahzl"><span class="MuiTypography-root MuiTypography-body1 c-1lky7cb">package.json</span><button tabIndex="0" type="button" aria-label="copy" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall c-1yipi07"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ContentCopyIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1k33q06"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button></div><pre style="background-color: #1E1E1E;" class="MuiTypography-root MuiTypography-body1 shiki c-12ogyw6"><code class="c-ceho3e"><span class="line"><span style="color: #D4D4D4;">{</span></span>
<span class="line"><span style="color: #D4D4D4;">  </span><span style="color: #9CDCFE;">&quot;scripts&quot;</span><span style="color: #D4D4D4;">: {</span></span>
<span class="line"><span style="color: #D4D4D4;">    </span><span style="color: #9CDCFE;">&quot;dev&quot;</span><span style="color: #D4D4D4;">: </span><span style="color: #CE9178;">&quot;parcel src/index.html&quot;</span><span style="color: #D4D4D4;">,</span></span>
<span class="line"><span style="color: #D4D4D4;">    </span><span style="color: #9CDCFE;">&quot;build&quot;</span><span style="color: #D4D4D4;">: </span><span style="color: #CE9178;">&quot;parcel build src/index.html&quot;</span><span style="color: #D4D4D4;">,</span></span>
<span class="line"><span style="color: #D4D4D4;">  },</span></span>
<span class="line"><span style="color: #D4D4D4;">  </span><span style="color: #9CDCFE;">&quot;devDependencies&quot;</span><span style="color: #D4D4D4;">: {</span></span>
<span class="line"><span style="color: #D4D4D4;">    </span><span style="color: #9CDCFE;">&quot;@types/webassembly-js-api&quot;</span><span style="color: #D4D4D4;">: </span><span style="color: #CE9178;">&quot;0.0.3&quot;</span><span style="color: #D4D4D4;">,</span></span>
<span class="line"><span style="color: #D4D4D4;">    </span><span style="color: #9CDCFE;">&quot;parcel-bundler&quot;</span><span style="color: #D4D4D4;">: </span><span style="color: #CE9178;">&quot;^1.12.3&quot;</span><span style="color: #D4D4D4;">,</span></span>
<span class="line"><span style="color: #D4D4D4;">    </span><span style="color: #9CDCFE;">&quot;parcel-plugin-wasm.rs&quot;</span><span style="color: #D4D4D4;">: </span><span style="color: #CE9178;">&quot;^1.2.8&quot;</span><span style="color: #D4D4D4;">,</span></span>
<span class="line"><span style="color: #D4D4D4;">    </span><span style="color: #9CDCFE;">&quot;typescript&quot;</span><span style="color: #D4D4D4;">: </span><span style="color: #CE9178;">&quot;^3.4.2&quot;</span></span>
<span class="line"><span style="color: #D4D4D4;">  },</span></span>
<span class="line"><span style="color: #D4D4D4;">  </span><span style="color: #9CDCFE;">&quot;browserslist&quot;</span><span style="color: #D4D4D4;">: [</span></span>
<span class="line"><span style="color: #D4D4D4;">    </span><span style="color: #CE9178;">&quot;last 2 chrome versions&quot;</span></span>
<span class="line"><span style="color: #D4D4D4;">  ]</span></span>
<span class="line"><span style="color: #D4D4D4;">}</span></span></code></pre></div>
<div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 c-14rm9aa"><div class="c-vlahzl"><span class="MuiTypography-root MuiTypography-body1 c-1lky7cb">Cargo.toml</span><button tabIndex="0" type="button" aria-label="copy" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall c-1yipi07"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ContentCopyIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1k33q06"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button></div><pre style="background-color: #1E1E1E;" class="MuiTypography-root MuiTypography-body1 shiki c-12ogyw6"><code class="c-ceho3e"><span class="line"><span style="color: #D4D4D4;">[package]</span></span>
<span class="line"><span style="color: #9CDCFE;">name</span><span style="color: #D4D4D4;"> = </span><span style="color: #CE9178;">&quot;wasm&quot;</span></span>
<span class="line"><span style="color: #9CDCFE;">version</span><span style="color: #D4D4D4;"> = </span><span style="color: #CE9178;">&quot;0.1.0&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4;">[dependencies]</span></span>
<span class="line"><span style="color: #9CDCFE;">wasm-bindgen</span><span style="color: #D4D4D4;"> = </span><span style="color: #CE9178;">&quot;^0.2&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4;">[lib]</span></span>
<span class="line"><span style="color: #9CDCFE;">crate-type</span><span style="color: #D4D4D4;"> = [</span><span style="color: #CE9178;">&quot;cdylib&quot;</span><span style="color: #D4D4D4;">]</span></span>
<span class="line"><span style="color: #9CDCFE;">path</span><span style="color: #D4D4D4;"> = </span><span style="color: #CE9178;">&quot;./src/wasm/lib.rs&quot;</span></span></code></pre></div>
<div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 c-14rm9aa"><div class="c-vlahzl"><span class="MuiTypography-root MuiTypography-body1 c-1lky7cb">tsconfig.json</span><button tabIndex="0" type="button" aria-label="copy" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall c-1yipi07"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ContentCopyIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1k33q06"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button></div><pre style="background-color: #1E1E1E;" class="MuiTypography-root MuiTypography-body1 shiki c-12ogyw6"><code class="c-ceho3e"><span class="line"><span style="color: #D4D4D4;">{</span></span>
<span class="line"><span style="color: #D4D4D4;">  </span><span style="color: #9CDCFE;">&quot;compilerOptions&quot;</span><span style="color: #D4D4D4;">: {</span></span>
<span class="line"><span style="color: #D4D4D4;">    </span><span style="color: #9CDCFE;">&quot;target&quot;</span><span style="color: #D4D4D4;">: </span><span style="color: #CE9178;">&quot;es2015&quot;</span><span style="color: #D4D4D4;">,</span></span>
<span class="line"><span style="color: #D4D4D4;">    </span><span style="color: #9CDCFE;">&quot;lib&quot;</span><span style="color: #D4D4D4;">: [</span></span>
<span class="line"><span style="color: #D4D4D4;">      </span><span style="color: #CE9178;">&quot;es2015&quot;</span><span style="color: #D4D4D4;">,</span></span>
<span class="line"><span style="color: #D4D4D4;">      </span><span style="color: #CE9178;">&quot;dom&quot;</span><span style="color: #D4D4D4;">,</span></span>
<span class="line"><span style="color: #D4D4D4;">      </span><span style="color: #CE9178;">&quot;webworker&quot;</span></span>
<span class="line"><span style="color: #D4D4D4;">    ],</span></span>
<span class="line"><span style="color: #D4D4D4;">    </span><span style="color: #9CDCFE;">&quot;strict&quot;</span><span style="color: #D4D4D4;">: </span><span style="color: #569CD6;">true</span><span style="color: #D4D4D4;">,</span></span>
<span class="line"><span style="color: #D4D4D4;">    </span><span style="color: #9CDCFE;">&quot;esModuleInterop&quot;</span><span style="color: #D4D4D4;">: </span><span style="color: #569CD6;">true</span></span>
<span class="line"><span style="color: #D4D4D4;">  }</span></span>
<span class="line"><span style="color: #D4D4D4;">}</span></span></code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">WebAssembly未対応のIEを切り捨て、TypeScriptのコンパイルはes2015で行っている。parcelのbabel側でes5に変換されないよう、<code class="c-1f8td17">package.json</code>では<code class="c-1f8td17">browserslist</code>の設定を行う。</p>
<h2 class="MuiTypography-root MuiTypography-h4 c-1ugattu">各ファイル</h2>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">全部書くのも面倒なので、各ファイルのインポート部分だけ書いていく。
書き足している場所もあるが、全体はサンプルリポジトリを参照。
<a href="https://github.com/iMasanari/wasm-bindgen-with-worker" target="_blank" rel="noopener" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways c-15kjgm">iMasanari/wasm-bindgen-with-worker</a></p>
<div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 c-14rm9aa"><div class="c-vlahzl"><span class="MuiTypography-root MuiTypography-body1 c-1lky7cb">src/index.html</span><button tabIndex="0" type="button" aria-label="copy" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall c-1yipi07"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ContentCopyIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1k33q06"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button></div><pre style="background-color: #1E1E1E;" class="MuiTypography-root MuiTypography-body1 shiki c-12ogyw6"><code class="c-ceho3e"><span class="line"><span style="color: #808080;">&lt;</span><span style="color: #569CD6;">script</span><span style="color: #D4D4D4;"> </span><span style="color: #9CDCFE;">src</span><span style="color: #D4D4D4;">=</span><span style="color: #CE9178;">&quot;app/index.ts&quot;</span><span style="color: #808080;">>&lt;/</span><span style="color: #569CD6;">script</span><span style="color: #808080;">></span></span></code></pre></div>
<div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 c-14rm9aa"><div class="c-vlahzl"><span class="MuiTypography-root MuiTypography-body1 c-1lky7cb">src/app/index.ts</span><button tabIndex="0" type="button" aria-label="copy" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall c-1yipi07"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ContentCopyIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1k33q06"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button></div><pre style="background-color: #1E1E1E;" class="MuiTypography-root MuiTypography-body1 shiki c-12ogyw6"><code class="c-ceho3e"><span class="line"><span style="color: #569CD6;">const</span><span style="color: #D4D4D4;"> </span><span style="color: #4FC1FF;">worker</span><span style="color: #D4D4D4;"> = </span><span style="color: #569CD6;">new</span><span style="color: #D4D4D4;"> </span><span style="color: #DCDCAA;">Worker</span><span style="color: #D4D4D4;">(</span><span style="color: #CE9178;">'../worker/index.ts'</span><span style="color: #D4D4D4;">)</span></span></code></pre></div>
<div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 c-14rm9aa"><div class="c-vlahzl"><span class="MuiTypography-root MuiTypography-body1 c-1lky7cb">src/worker/index.ts</span><button tabIndex="0" type="button" aria-label="copy" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall c-1yipi07"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ContentCopyIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1k33q06"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button></div><pre style="background-color: #1E1E1E;" class="MuiTypography-root MuiTypography-body1 shiki c-12ogyw6"><code class="c-ceho3e"><span class="line"><span style="color: #C586C0;">import</span><span style="color: #D4D4D4;"> </span><span style="color: #569CD6;">*</span><span style="color: #D4D4D4;"> </span><span style="color: #C586C0;">as</span><span style="color: #D4D4D4;"> </span><span style="color: #9CDCFE;">wasm</span><span style="color: #D4D4D4;"> </span><span style="color: #C586C0;">from</span><span style="color: #D4D4D4;"> </span><span style="color: #CE9178;">'../wasm/lib.rs'</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955;">// WebAssemblyの実行</span></span>
<span class="line"><span style="color: #9CDCFE;">wasm</span><span style="color: #D4D4D4;">.</span><span style="color: #DCDCAA;">some_function</span><span style="color: #D4D4D4;">(</span><span style="color: #CE9178;">'WebAssembly'</span><span style="color: #D4D4D4;">)</span></span></code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">あとは、Rustの関数を作るだけ。
現在のWebAssemblyは数値しかやりとりができないが、wasm-bindgenを使うことで文字列やJSONもやりとりができるようになる。</p>
<div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 c-14rm9aa"><div class="c-vlahzl"><span class="MuiTypography-root MuiTypography-body1 c-1lky7cb">src/wasm/lib.rs</span><button tabIndex="0" type="button" aria-label="copy" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall c-1yipi07"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ContentCopyIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1k33q06"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button></div><pre style="background-color: #1E1E1E;" class="MuiTypography-root MuiTypography-body1 shiki c-12ogyw6"><code class="c-ceho3e"><span class="line"><span style="color: #569CD6;">extern</span><span style="color: #D4D4D4;"> </span><span style="color: #569CD6;">crate</span><span style="color: #D4D4D4;"> wasm_bindgen;</span></span>
<span class="line"><span style="color: #569CD6;">use</span><span style="color: #D4D4D4;"> </span><span style="color: #4EC9B0;">wasm_bindgen</span><span style="color: #D4D4D4;">::</span><span style="color: #4EC9B0;">prelude</span><span style="color: #D4D4D4;">::*;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4;">#[wasm_bindgen]</span></span>
<span class="line"><span style="color: #569CD6;">pub</span><span style="color: #D4D4D4;"> </span><span style="color: #569CD6;">fn</span><span style="color: #D4D4D4;"> </span><span style="color: #DCDCAA;">some_function</span><span style="color: #D4D4D4;">(</span><span style="color: #9CDCFE;">input</span><span style="color: #D4D4D4;">: &amp;</span><span style="color: #4EC9B0;">str</span><span style="color: #D4D4D4;">) -> </span><span style="color: #4EC9B0;">String</span><span style="color: #D4D4D4;"> {</span></span>
<span class="line"><span style="color: #D4D4D4;">    </span><span style="color: #DCDCAA;">format!</span><span style="color: #D4D4D4;">(</span><span style="color: #CE9178;">&quot;Hello, {}!&quot;</span><span style="color: #D4D4D4;">, </span><span style="color: #9CDCFE;">input</span><span style="color: #D4D4D4;">)</span></span>
<span class="line"><span style="color: #D4D4D4;">}</span></span></code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">ビルドも下記コマンドだけでOK。
初回だけ、Rustのビルドに時間がかかる。</p>
<div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 c-14rm9aa"><div class="c-vlahzl"><span class="MuiTypography-root MuiTypography-body1 c-1lky7cb"></span><button tabIndex="0" type="button" aria-label="copy" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall c-1yipi07"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ContentCopyIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1k33q06"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button></div><pre style="background-color: #1E1E1E;" class="MuiTypography-root MuiTypography-body1 shiki c-12ogyw6"><code class="c-ceho3e"><span class="line"><span style="color: #6A9955;"># デバッグ用ビルド + サーバー</span></span>
<span class="line"><span style="color: #D4D4D4;">$ npm run dev</span></span></code></pre></div>
<div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 c-14rm9aa"><div class="c-vlahzl"><span class="MuiTypography-root MuiTypography-body1 c-1lky7cb"></span><button tabIndex="0" type="button" aria-label="copy" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall c-1yipi07"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ContentCopyIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1k33q06"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button></div><pre style="background-color: #1E1E1E;" class="MuiTypography-root MuiTypography-body1 shiki c-12ogyw6"><code class="c-ceho3e"><span class="line"><span style="color: #6A9955;"># プロダクションビルド</span></span>
<span class="line"><span style="color: #D4D4D4;">$ npm run build</span></span></code></pre></div>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">出力結果はこんな感じ。
なぜか<code class="c-1f8td17">lib.rs</code>まで出力されているが、ちゃんとハッシュが付いているのが確認できる。</p>
<div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 c-14rm9aa"><div class="c-vlahzl"><span class="MuiTypography-root MuiTypography-body1 c-1lky7cb"></span><button tabIndex="0" type="button" aria-label="copy" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall c-1yipi07"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ContentCopyIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1k33q06"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button></div><pre style="background-color: #1E1E1E;" class="MuiTypography-root MuiTypography-body1 shiki c-12ogyw6"><code class="c-ceho3e"><span class="line"><span style="color: #D4D4D4;">$ tree dist</span></span>
<span class="line"><span style="color: #D4D4D4;">dist</span></span>
<span class="line"><span style="color: #D4D4D4;">├── app.68414551.js</span></span>
<span class="line"><span style="color: #D4D4D4;">├── index.html</span></span>
<span class="line"><span style="color: #D4D4D4;">├── lib.3d22fd5b.rs</span></span>
<span class="line"><span style="color: #D4D4D4;">├── wasm_bg.ead9fc9c.wasm</span></span>
<span class="line"><span style="color: #D4D4D4;">└── worker.135e8d27.js</span></span></code></pre></div>
<h2 class="MuiTypography-root MuiTypography-h4 c-1ugattu">Webpackとの違い</h2>
<h3 class="MuiTypography-root MuiTypography-h5 c-15x2j1y">RustからのJavaScriptコード呼び出しパス</h3>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">Webpackでは、pkgフォルダ内のファイルをインポートするため、相対パスの基準は<code class="c-ceho3e">pkg/</code>である。
parcel(parcel-plugin-wasm.rs)では、<code class="c-ceho3e">node_modules/parcel-plugin-wasm.rs/</code>が基準である。parcelの絶対パス（<code class="c-ceho3e">/*</code>）を使えば、エントリーファイルの場所（今回は<code class="c-ceho3e">src/</code>）が基準になる。</p>
<div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 c-14rm9aa"><div class="c-vlahzl"><span class="MuiTypography-root MuiTypography-body1 c-1lky7cb">src/wasm/lib.rs</span><button tabIndex="0" type="button" aria-label="copy" class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall c-1yipi07"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ContentCopyIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1k33q06"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg></button></div><pre style="background-color: #1E1E1E;" class="MuiTypography-root MuiTypography-body1 shiki c-12ogyw6"><code class="c-ceho3e"><span class="line"><span style="color: #D4D4D4;">#[wasm_bindgen(module = </span><span style="color: #CE9178;">&quot;/worker/wasm-util&quot;</span><span style="color: #D4D4D4;">)]</span></span>
<span class="line"><span style="color: #569CD6;">extern</span><span style="color: #D4D4D4;"> {</span></span>
<span class="line"><span style="color: #D4D4D4;">    </span><span style="color: #569CD6;">fn</span><span style="color: #D4D4D4;"> </span><span style="color: #DCDCAA;">console_log</span><span style="color: #D4D4D4;">(</span><span style="color: #9CDCFE;">s</span><span style="color: #D4D4D4;">: &amp;</span><span style="color: #4EC9B0;">str</span><span style="color: #D4D4D4;">);</span></span>
<span class="line"><span style="color: #D4D4D4;">}</span></span></code></pre></div>
<h3 class="MuiTypography-root MuiTypography-h5 c-15x2j1y">WebWorker側でのRustインポート</h3>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">Webpackでは、WASMをインポートするまでに必ずDynamic importを挟む必要がある。
parcelではその必要がなく、直接importする。（そもそもWebWroker内でのDynamic importがサポートされていない？）</p>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">つまり、parcelではWASMロード中の<code class="c-1f8td17">postMessage</code>を取りこぼしてしまう可能性がある。
そのため<a href="https://github.com/iMasanari/wasm-bindgen-with-worker" target="_blank" rel="noopener" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways c-15kjgm">サンプル</a>では、<a href="https://github.com/iMasanari/wasm-bindgen-with-worker/blob/master/src/app/wasmWorker.ts#L24" target="_blank" rel="noopener" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways c-15kjgm">ロードを待ってからメッセージを送る</a>ようにしている。</p>
<h2 class="MuiTypography-root MuiTypography-h4 c-1ugattu">まとめ</h2>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">parcelを使うことで、簡単にWebAssemblyが始められる。</p>
<p class="MuiTypography-root MuiTypography-body1 c-y25xid">ちなみにRustは、C言語並みの処理スピードを持ちながらモダンな文法と強力なコンパイル時チェックを備えている言語でおすすめ！　所有権、借用、ライフタイム？　学習コストが高い？　知らんな。一緒に<a href="https://doc.rust-jp.rs/the-rust-programming-language-ja/1.6/book/references-and-borrowing.html#%E6%A6%82%E8%AB%96" target="_blank" rel="noopener" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways c-15kjgm">借用チェッカと戦おうぜ！</a> by Rust初心者</p></main></article><ul class="c-1aue7hj"><li class="c-1sl6rns"><a href="/blog/difference-between-jsx-and-html/" class="MuiTypography-root MuiTypography-body1 MuiLink-root MuiLink-underlineAlways c-f7hjxq">HTMLでは使えないJSX独自の書き方</a></li><li class="c-1bhrv1p"><a href="/" class="MuiTypography-root MuiTypography-body1 MuiLink-root MuiLink-underlineAlways c-f7hjxq">HOME</a></li><li class="c-mpp38z"><a href="/blog/use-parcel/" class="MuiTypography-root MuiTypography-body1 MuiLink-root MuiLink-underlineAlways c-f7hjxq">ブログ開発をParcelに変更した</a></li></ul><aside class="c-ze4krk"><header><h1 class="MuiTypography-root MuiTypography-h5 c-1jnynlu">同じタグを含む記事</h1><ul class="c-ntfpy7"> <li class="c-1vaygba"><a href="/tags/Rust/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#Rust</a></li> <li class="c-1vaygba"><a href="/tags/wasm-bindgen/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#wasm-bindgen</a></li> <li class="c-1vaygba"><a href="/tags/TypeScript/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#TypeScript</a></li> <li class="c-1vaygba"><a href="/tags/parcel/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#parcel</a></li></ul></header><main><ul class="c-1rvtlej"><li class="c-116qoqd"><article><header><div class="c-1n6wxgb"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="CalendarTodayIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1qh3bxa"><path d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13z"></path></svg><time dateTime="2019-04-26T13:55:56.097Z" class="MuiTypography-root MuiTypography-body2 c-16n8wpk">2019-04-26</time></div><h1 class="MuiTypography-root MuiTypography-h5 MuiTypography-gutterBottom c-1ihubty"><a href="/blog/use-parcel/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways c-15kjgm">ブログ開発をParcelに変更した</a></h1><ul class="c-ntfpy7"> <li class="c-1vaygba"><a href="/tags/parcel/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#parcel</a></li> <li class="c-1vaygba"><a href="/tags/blog/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#blog</a></li></ul></header></article></li><li class="c-116qoqd"><article><header><div class="c-1n6wxgb"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="CalendarTodayIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1qh3bxa"><path d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13z"></path></svg><time dateTime="2018-07-13T12:47:36.148Z" class="MuiTypography-root MuiTypography-body2 c-16n8wpk">2018-07-13</time></div><h1 class="MuiTypography-root MuiTypography-h5 MuiTypography-gutterBottom c-1ihubty"><a href="/blog/remove-object-key/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways c-15kjgm">【ES.next】Objectから任意のキーを削除した新しいObjectを作成する</a></h1><ul class="c-ntfpy7"> <li class="c-1vaygba"><a href="/tags/JavaScript/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#JavaScript</a></li> <li class="c-1vaygba"><a href="/tags/Babel/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#Babel</a></li> <li class="c-1vaygba"><a href="/tags/TypeScript/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#TypeScript</a></li></ul></header></article></li><li class="c-116qoqd"><article><header><div class="c-1n6wxgb"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="CalendarTodayIcon" class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall c-1qh3bxa"><path d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13z"></path></svg><time dateTime="2018-07-03T11:47:13.910Z" class="MuiTypography-root MuiTypography-body2 c-16n8wpk">2018-07-03</time></div><h1 class="MuiTypography-root MuiTypography-h5 MuiTypography-gutterBottom c-1ihubty"><a href="/blog/webpacks-rules-in-static-config-js/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways c-15kjgm">React StaticでTypeScriptを使用した時のエラー対処法</a></h1><ul class="c-ntfpy7"> <li class="c-1vaygba"><a href="/tags/ReactStatic/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#ReactStatic</a></li> <li class="c-1vaygba"><a href="/tags/TypeScript/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#TypeScript</a></li> <li class="c-1vaygba"><a href="/tags/webpack/" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover c-1f5kc47">#webpack</a></li></ul></header></article></li></ul></main></aside></div><footer class="c-1d3ah2d"><div class="MuiContainer-root MuiContainer-maxWidthLg c-1qsxih2"><p class="MuiTypography-root MuiTypography-body1 MuiTypography-gutterBottom c-fnf71d">Author: <a href="https://github.com/iMasanari" class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways c-15kjgm">iMasanari</a></p><a href="https://github.com/iMasanari/imasanari.github.io/" class="MuiTypography-root MuiTypography-body2 MuiLink-root MuiLink-underlineAlways c-19fxvs2">Show on GitHub</a></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Rust + wasm-bindgen + WebWorkerの環境構築","description":"WebAssembly Advent Calendar 2018の20日目の記事。","slug":"wasm-bindgen-with-worker","tags":["Rust","wasm-bindgen","TypeScript","parcel"],"date":"2018-12-20T14:58:37.388Z","update":"2019-04-20T13:15:27.878Z","image":null,"draft":false},"next":{"title":"ブログ開発をParcelに変更した","description":"前回の記事でparcelを使用して便利だったので、このブログのモジュールバンドラをparcelに変更した。決め手は、Tree Shakingがサポートされていたから。","slug":"use-parcel","tags":["parcel","blog"],"date":"2019-04-26T13:55:56.097Z","update":null,"image":null,"draft":false},"prev":{"title":"HTMLでは使えないJSX独自の書き方","description":"HTMLとReact JSXの書き方の違いでハマったポイントをまとめた。","slug":"difference-between-jsx-and-html","tags":["React"],"date":"2018-08-13T14:57:58.277Z","update":null,"image":null,"draft":false},"sameTags":[{"title":"ブログ開発をParcelに変更した","description":"前回の記事でparcelを使用して便利だったので、このブログのモジュールバンドラをparcelに変更した。決め手は、Tree Shakingがサポートされていたから。","slug":"use-parcel","tags":["parcel","blog"],"date":"2019-04-26T13:55:56.097Z","update":null,"image":null,"draft":false},{"title":"【ES.next】Objectから任意のキーを削除した新しいObjectを作成する","description":"ブログを作る前、Qiitaに投稿しようと書いていたけど途中でやめ、最近まで忘れていた記事です。Qiitaでもいいけど、せっかくだからこっちに置いておきます。","slug":"remove-object-key","tags":["JavaScript","Babel","TypeScript"],"date":"2018-07-13T12:47:36.148Z","update":null,"image":null,"draft":false},{"title":"React StaticでTypeScriptを使用した時のエラー対処法","description":"static.config.jsのwebpack設定を変更することで起こるエラーの対処法。","slug":"webpacks-rules-in-static-config-js","tags":["ReactStatic","TypeScript","webpack"],"date":"2018-07-03T11:47:13.910Z","update":null,"image":null,"draft":false}],"content":"\u003cp\u003e\u003ca href=\"https://qiita.com/advent-calendar/2018/wasm\"\u003eWebAssembly Advent Calendar 2018\u003c/a\u003eの20日目の記事。\n※ 2019/4/20: 修正\u003c/p\u003e\n\u003ch2\u003eTL;DR\u003c/h2\u003e\n\u003cp\u003eparcelのparcel-plugin-wasm.rsプラグインを使用しよう！\u003c/p\u003e\n\u003cp\u003eサンプルリポジトリはこちら\n\u003ca href=\"https://github.com/iMasanari/wasm-bindgen-with-worker\"\u003eiMasanari/wasm-bindgen-with-worker\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003eやりたいこと\u003c/h2\u003e\n\u003cp\u003e時間のかかる処理をWebAssemblyで高速に行いたい。そのためには、下記の条件が必要になる。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e引数や戻り値をJSON形式でやりとりできること\u003c/li\u003e\n\u003cli\u003e非同期処理であること\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e今回は、Rustでwasm-bindgenを使用し、WebWorker内で動かす環境を作っていく。\u003c/p\u003e\n\u003ch2\u003e1度、WebPackで構築するも……\u003c/h2\u003e\n\u003cp\u003eまずは、\u003ca href=\"https://www.mizdra.net/entry/2018/10/17/080000\"\u003eWebAssemblyを使って乱数調整ツールをWebに移植した話\u003c/a\u003eを元に、WebPackで構築した。しかし、3つの気になる点が出てきた。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eWorker用のエントリーファイルをもう1つ用意しなければならない\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/webpack/webpack/issues/7647\"\u003eCannot import wasm in web workers #7647\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e中間ファイル生成（Rust→wasm）のせいで、ビルドタスクが煩雑になる\u003c/li\u003e\n\u003cli\u003eライブリロード\n\u003cul\u003e\n\u003cli\u003eワンテンポ遅いタイミングでページ全体のリロードがされる\u003c/li\u003e\n\u003cli\u003eリロードの読み込み時間も長い\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eエントリーファイルの問題は、WebWorkerのファイル名にハッシュ（\u003ccode\u003eworker.2290ab9e.js\u003c/code\u003eの\u003ccode\u003e2290ab9e\u003c/code\u003e部分）が付けられないことである。今回はスクリプトがView、WebWorker、WASMの3ファイルに分かれるので、キャッシュ対策のためにも必要度は高い。\u003c/p\u003e\n\u003ch2\u003eparcelでの環境構築\u003c/h2\u003e\n\u003cp\u003eWebpackで環境を作って数日後、ふと別のモジュールバンドラを使用すればよいのではと思い、parcelで試してみた。すると、上記のエントリーファイル問題、中間ファイル問題を解決することができた。\nライブリロードの件は一応差分更新を試みてくれるが、Rustの更新内容は反映されなかった。ただ、普段ライブリロードは使わず、またワンテンポ遅れの全リロードでないためそこまで問題は感じていない。\u003c/p\u003e\n\u003cp\u003eなぜ最初にparcelで試さなかったのかというと、情報がWebpackのものしかなかったからだ。なので今回、parcelでWebWorker + WebAssemblyを扱う方法を共有したい。（といっても、parcelがゼロコンフィグなモジュールバンドラのため、そこまで凝ったことはしていない）\u003c/p\u003e\n\u003ch2\u003e各種インストール\u003c/h2\u003e\n\u003cp\u003eNode.jsやRustはインストール済みとする。\u003c/p\u003e\n\u003cp\u003eparcelのインストール\u003c/p\u003e\n\u003cp\u003e\u003cdel\u003eparcel-plugin-wasm.rs v1.2.7はparcel-bundler v1.11.0に対応していないのかビルドエラーになったため、バージョンを指定してインストールしている。\u003c/del\u003e\u003c/p\u003e\n\u003cp\u003e※最新バージョンで治っていることを確認。\u003c/p\u003e\n\u003capp-code-wrapper lang=\"bash\" code=\"$ npm install -D parcel-bundler parcel-plugin-wasm.rs\"\u003e\u003cpre class=\"shiki\" style=\"background-color: #1E1E1E\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e$ npm install -D parcel-bundler parcel-plugin-wasm.rs\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/app-code-wrapper\u003e\n\u003cp\u003eparcel-plugin-wasm.rsはRustをwasm-packでコンパイルするためのparcelのプラグイン。wasm-packのインストールがまだの場合はインストールする。\u003c/p\u003e\n\u003capp-code-wrapper lang=\"bash\" code=\"$ cargo install wasm-pack\"\u003e\u003cpre class=\"shiki\" style=\"background-color: #1E1E1E\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e$ cargo install wasm-pack\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/app-code-wrapper\u003e\n\u003cp\u003e個人的にいつもTypeScriptを使うので、それ関連のインストール。\n\u003ca href=\"https://www.npmjs.com/package/@types/webassembly-js-api\"\u003e@types/webassembly-js-api\u003c/a\u003eは、WebAssemblyの型定義。\u003c/p\u003e\n\u003capp-code-wrapper lang=\"bash\" code=\"$ npm install -D typescript @types/webassembly-js-api\"\u003e\u003cpre class=\"shiki\" style=\"background-color: #1E1E1E\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e$ npm install -D typescript @types/webassembly-js-api\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/app-code-wrapper\u003e\n\u003ch2\u003eフォルダ構成と設定ファイル\u003c/h2\u003e\n\u003ch3\u003eフォルダ構成（srcフォルダ）\u003c/h3\u003e\n\u003cp\u003e各種フォルダとエントリーポイントのHTMLという構成で、個人的にすごくきれいな配置だと思う。\nちなみにこの出力をするためにMacへTreeコマンドを入れた。\u003c/p\u003e\n\u003capp-code-wrapper lang=\"bash\" code=\"$ tree src\nsrc\n├── app\n│   └── index.ts\n├── wasm\n│   ├── lib.rs\n│   └── lib.rs.d.ts\n├── worker\n│   └── index.ts\n└── index.html\"\u003e\u003cpre class=\"shiki\" style=\"background-color: #1E1E1E\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e$ tree src\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003esrc\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e├── app\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e│   └── index.ts\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e├── wasm\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e│   ├── lib.rs\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e│   └── lib.rs.d.ts\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e├── worker\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e│   └── index.ts\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e└── index.html\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/app-code-wrapper\u003e\n\u003ch3\u003e各種設定ファイル（必要最低限の箇所のみ）\u003c/h3\u003e\n\u003capp-code-wrapper title=\"package.json\" lang=\"json\" code=\"{\n  \u0026#x22;scripts\u0026#x22;: {\n    \u0026#x22;dev\u0026#x22;: \u0026#x22;parcel src/index.html\u0026#x22;,\n    \u0026#x22;build\u0026#x22;: \u0026#x22;parcel build src/index.html\u0026#x22;,\n  },\n  \u0026#x22;devDependencies\u0026#x22;: {\n    \u0026#x22;@types/webassembly-js-api\u0026#x22;: \u0026#x22;0.0.3\u0026#x22;,\n    \u0026#x22;parcel-bundler\u0026#x22;: \u0026#x22;^1.12.3\u0026#x22;,\n    \u0026#x22;parcel-plugin-wasm.rs\u0026#x22;: \u0026#x22;^1.2.8\u0026#x22;,\n    \u0026#x22;typescript\u0026#x22;: \u0026#x22;^3.4.2\u0026#x22;\n  },\n  \u0026#x22;browserslist\u0026#x22;: [\n    \u0026#x22;last 2 chrome versions\u0026#x22;\n  ]\n}\"\u003e\u003cpre class=\"shiki\" style=\"background-color: #1E1E1E\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003e\u0026quot;scripts\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003e\u0026quot;dev\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;parcel src/index.html\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003e\u0026quot;build\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;parcel build src/index.html\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e  },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003e\u0026quot;devDependencies\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003e\u0026quot;@types/webassembly-js-api\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;0.0.3\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003e\u0026quot;parcel-bundler\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;^1.12.3\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003e\u0026quot;parcel-plugin-wasm.rs\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;^1.2.8\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003e\u0026quot;typescript\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;^3.4.2\u0026quot;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e  },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003e\u0026quot;browserslist\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;last 2 chrome versions\u0026quot;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e  ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/app-code-wrapper\u003e\n\u003capp-code-wrapper title=\"Cargo.toml\" lang=\"toml\" code=\"[package]\nname = \u0026#x22;wasm\u0026#x22;\nversion = \u0026#x22;0.1.0\u0026#x22;\n\n[dependencies]\nwasm-bindgen = \u0026#x22;^0.2\u0026#x22;\n\n[lib]\ncrate-type = [\u0026#x22;cdylib\u0026#x22;]\npath = \u0026#x22;./src/wasm/lib.rs\u0026#x22;\"\u003e\u003cpre class=\"shiki\" style=\"background-color: #1E1E1E\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e[package]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #9CDCFE\"\u003ename\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e = \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;wasm\u0026quot;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #9CDCFE\"\u003eversion\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e = \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;0.1.0\u0026quot;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e[dependencies]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #9CDCFE\"\u003ewasm-bindgen\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e = \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;^0.2\u0026quot;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e[lib]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #9CDCFE\"\u003ecrate-type\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e = [\u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;cdylib\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #9CDCFE\"\u003epath\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e = \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;./src/wasm/lib.rs\u0026quot;\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/app-code-wrapper\u003e\n\u003capp-code-wrapper title=\"tsconfig.json\" lang=\"json\" code=\"{\n  \u0026#x22;compilerOptions\u0026#x22;: {\n    \u0026#x22;target\u0026#x22;: \u0026#x22;es2015\u0026#x22;,\n    \u0026#x22;lib\u0026#x22;: [\n      \u0026#x22;es2015\u0026#x22;,\n      \u0026#x22;dom\u0026#x22;,\n      \u0026#x22;webworker\u0026#x22;\n    ],\n    \u0026#x22;strict\u0026#x22;: true,\n    \u0026#x22;esModuleInterop\u0026#x22;: true\n  }\n}\"\u003e\u003cpre class=\"shiki\" style=\"background-color: #1E1E1E\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003e\u0026quot;compilerOptions\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003e\u0026quot;target\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;es2015\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003e\u0026quot;lib\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;es2015\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;dom\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e      \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;webworker\u0026quot;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e    ],\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003e\u0026quot;strict\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #569CD6\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003e\u0026quot;esModuleInterop\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #569CD6\"\u003etrue\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/app-code-wrapper\u003e\n\u003cp\u003eWebAssembly未対応のIEを切り捨て、TypeScriptのコンパイルはes2015で行っている。parcelのbabel側でes5に変換されないよう、\u003ccode\u003epackage.json\u003c/code\u003eでは\u003ccode\u003ebrowserslist\u003c/code\u003eの設定を行う。\u003c/p\u003e\n\u003ch2\u003e各ファイル\u003c/h2\u003e\n\u003cp\u003e全部書くのも面倒なので、各ファイルのインポート部分だけ書いていく。\n書き足している場所もあるが、全体はサンプルリポジトリを参照。\n\u003ca href=\"https://github.com/iMasanari/wasm-bindgen-with-worker\"\u003eiMasanari/wasm-bindgen-with-worker\u003c/a\u003e\u003c/p\u003e\n\u003capp-code-wrapper title=\"src/index.html\" lang=\"html\" code=\"\u003cscript src=\u0026#x22;app/index.ts\u0026#x22;\u003e\u003c/script\u003e\"\u003e\u003cpre class=\"shiki\" style=\"background-color: #1E1E1E\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #808080\"\u003e\u0026lt;\u003c/span\u003e\u003cspan style=\"color: #569CD6\"\u003escript\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003esrc\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;app/index.ts\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #808080\"\u003e\u0026gt;\u0026lt;/\u003c/span\u003e\u003cspan style=\"color: #569CD6\"\u003escript\u003c/span\u003e\u003cspan style=\"color: #808080\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/app-code-wrapper\u003e\n\u003capp-code-wrapper title=\"src/app/index.ts\" lang=\"typescript\" code=\"const worker = new Worker(\u0026#x27;../worker/index.ts\u0026#x27;)\"\u003e\u003cpre class=\"shiki\" style=\"background-color: #1E1E1E\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #569CD6\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e \u003c/span\u003e\u003cspan style=\"color: #4FC1FF\"\u003eworker\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e = \u003c/span\u003e\u003cspan style=\"color: #569CD6\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCDCAA\"\u003eWorker\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026#39;../worker/index.ts\u0026#39;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/app-code-wrapper\u003e\n\u003capp-code-wrapper title=\"src/worker/index.ts\" lang=\"typescript\" code=\"import * as wasm from \u0026#x27;../wasm/lib.rs\u0026#x27;\n\n// WebAssemblyの実行\nwasm.some_function(\u0026#x27;WebAssembly\u0026#x27;)\"\u003e\u003cpre class=\"shiki\" style=\"background-color: #1E1E1E\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #C586C0\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e \u003c/span\u003e\u003cspan style=\"color: #569CD6\"\u003e*\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e \u003c/span\u003e\u003cspan style=\"color: #C586C0\"\u003eas\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003ewasm\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e \u003c/span\u003e\u003cspan style=\"color: #C586C0\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026#39;../wasm/lib.rs\u0026#39;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #6A9955\"\u003e// WebAssemblyの実行\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #9CDCFE\"\u003ewasm\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #DCDCAA\"\u003esome_function\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026#39;WebAssembly\u0026#39;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e)\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/app-code-wrapper\u003e\n\u003cp\u003eあとは、Rustの関数を作るだけ。\n現在のWebAssemblyは数値しかやりとりができないが、wasm-bindgenを使うことで文字列やJSONもやりとりができるようになる。\u003c/p\u003e\n\u003capp-code-wrapper title=\"src/wasm/lib.rs\" lang=\"rust\" code=\"extern crate wasm_bindgen;\nuse wasm_bindgen::prelude::*;\n\n#[wasm_bindgen]\npub fn some_function(input: \u0026#x26;str) -\u003e String {\n    format!(\u0026#x22;Hello, {}!\u0026#x22;, input)\n}\"\u003e\u003cpre class=\"shiki\" style=\"background-color: #1E1E1E\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #569CD6\"\u003eextern\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e \u003c/span\u003e\u003cspan style=\"color: #569CD6\"\u003ecrate\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e wasm_bindgen;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #569CD6\"\u003euse\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e \u003c/span\u003e\u003cspan style=\"color: #4EC9B0\"\u003ewasm_bindgen\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e::\u003c/span\u003e\u003cspan style=\"color: #4EC9B0\"\u003eprelude\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e::*;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e#[wasm_bindgen]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #569CD6\"\u003epub\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e \u003c/span\u003e\u003cspan style=\"color: #569CD6\"\u003efn\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCDCAA\"\u003esome_function\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003einput\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: \u0026amp;\u003c/span\u003e\u003cspan style=\"color: #4EC9B0\"\u003estr\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e) -\u0026gt; \u003c/span\u003e\u003cspan style=\"color: #4EC9B0\"\u003eString\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #DCDCAA\"\u003eformat!\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;Hello, {}!\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003einput\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/app-code-wrapper\u003e\n\u003cp\u003eビルドも下記コマンドだけでOK。\n初回だけ、Rustのビルドに時間がかかる。\u003c/p\u003e\n\u003capp-code-wrapper lang=\"bash\" code=\"# デバッグ用ビルド + サーバー\n$ npm run dev\"\u003e\u003cpre class=\"shiki\" style=\"background-color: #1E1E1E\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #6A9955\"\u003e# デバッグ用ビルド + サーバー\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e$ npm run dev\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/app-code-wrapper\u003e\n\u003capp-code-wrapper lang=\"bash\" code=\"# プロダクションビルド\n$ npm run build\"\u003e\u003cpre class=\"shiki\" style=\"background-color: #1E1E1E\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #6A9955\"\u003e# プロダクションビルド\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e$ npm run build\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/app-code-wrapper\u003e\n\u003cp\u003e出力結果はこんな感じ。\nなぜか\u003ccode\u003elib.rs\u003c/code\u003eまで出力されているが、ちゃんとハッシュが付いているのが確認できる。\u003c/p\u003e\n\u003capp-code-wrapper lang=\"bash\" code=\"$ tree dist\ndist\n├── app.68414551.js\n├── index.html\n├── lib.3d22fd5b.rs\n├── wasm_bg.ead9fc9c.wasm\n└── worker.135e8d27.js\"\u003e\u003cpre class=\"shiki\" style=\"background-color: #1E1E1E\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e$ tree dist\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003edist\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e├── app.68414551.js\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e├── index.html\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e├── lib.3d22fd5b.rs\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e├── wasm_bg.ead9fc9c.wasm\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e└── worker.135e8d27.js\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/app-code-wrapper\u003e\n\u003ch2\u003eWebpackとの違い\u003c/h2\u003e\n\u003ch3\u003eRustからのJavaScriptコード呼び出しパス\u003c/h3\u003e\n\u003cp\u003eWebpackでは、pkgフォルダ内のファイルをインポートするため、相対パスの基準は\u003ccode\u003epkg/\u003c/code\u003eである。\nparcel(parcel-plugin-wasm.rs)では、\u003ccode\u003enode_modules/parcel-plugin-wasm.rs/\u003c/code\u003eが基準である。parcelの絶対パス（\u003ccode\u003e/*\u003c/code\u003e）を使えば、エントリーファイルの場所（今回は\u003ccode\u003esrc/\u003c/code\u003e）が基準になる。\u003c/p\u003e\n\u003capp-code-wrapper title=\"src/wasm/lib.rs\" lang=\"rust\" code=\"#[wasm_bindgen(module = \u0026#x22;/worker/wasm-util\u0026#x22;)]\nextern {\n    fn console_log(s: \u0026#x26;str);\n}\"\u003e\u003cpre class=\"shiki\" style=\"background-color: #1E1E1E\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e#[wasm_bindgen(module = \u003c/span\u003e\u003cspan style=\"color: #CE9178\"\u003e\u0026quot;/worker/wasm-util\u0026quot;\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e)]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #569CD6\"\u003eextern\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #569CD6\"\u003efn\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e \u003c/span\u003e\u003cspan style=\"color: #DCDCAA\"\u003econsole_log\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #9CDCFE\"\u003es\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e: \u0026amp;\u003c/span\u003e\u003cspan style=\"color: #4EC9B0\"\u003estr\u003c/span\u003e\u003cspan style=\"color: #D4D4D4\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D4D4D4\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/app-code-wrapper\u003e\n\u003ch3\u003eWebWorker側でのRustインポート\u003c/h3\u003e\n\u003cp\u003eWebpackでは、WASMをインポートするまでに必ずDynamic importを挟む必要がある。\nparcelではその必要がなく、直接importする。（そもそもWebWroker内でのDynamic importがサポートされていない？）\u003c/p\u003e\n\u003cp\u003eつまり、parcelではWASMロード中の\u003ccode\u003epostMessage\u003c/code\u003eを取りこぼしてしまう可能性がある。\nそのため\u003ca href=\"https://github.com/iMasanari/wasm-bindgen-with-worker\"\u003eサンプル\u003c/a\u003eでは、\u003ca href=\"https://github.com/iMasanari/wasm-bindgen-with-worker/blob/master/src/app/wasmWorker.ts#L24\"\u003eロードを待ってからメッセージを送る\u003c/a\u003eようにしている。\u003c/p\u003e\n\u003ch2\u003eまとめ\u003c/h2\u003e\n\u003cp\u003eparcelを使うことで、簡単にWebAssemblyが始められる。\u003c/p\u003e\n\u003cp\u003eちなみにRustは、C言語並みの処理スピードを持ちながらモダンな文法と強力なコンパイル時チェックを備えている言語でおすすめ！　所有権、借用、ライフタイム？　学習コストが高い？　知らんな。一緒に\u003ca href=\"https://doc.rust-jp.rs/the-rust-programming-language-ja/1.6/book/references-and-borrowing.html#%E6%A6%82%E8%AB%96\"\u003e借用チェッカと戦おうぜ！\u003c/a\u003e by Rust初心者\u003c/p\u003e"},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"wasm-bindgen-with-worker"},"buildId":"sshnfDrKevPjfNC6WQ_tP","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>