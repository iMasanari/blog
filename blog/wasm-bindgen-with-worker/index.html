<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Rust + wasm-bindgen + WebWorkerの環境構築 | Tech SANDBOX</title><meta name="description" content="WebAssembly Advent Calendar 2018の20日目の記事。"/><meta property="og:title" content="Rust + wasm-bindgen + WebWorkerの環境構築"/><meta property="og:description" content="WebAssembly Advent Calendar 2018の20日目の記事。"/><meta property="og:type" content="article"/><meta property="og:url" content="https://imasanari.github.io/blog/wasm-bindgen-with-worker"/><meta property="og:image" content="https://imasanari.github.io/images/icon.jpg"/><meta property="og:site_name" content="Tech SANDBOX"/><meta name="twitter:card" content="summary"/><meta name="next-head-count" content="11"/><link rel="preload" href="/_next/static/css/d4bd6111bf22fa15fd71.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d4bd6111bf22fa15fd71.css"/><link rel="preload" href="/_next/static/chunks/main-f01cf1dcca173d7f43b1.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-ccf5ab034a524403276a.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.6c6c2144b5674c37af03.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.65195c3ca934dc067d4c.js" as="script"/><link rel="preload" href="/_next/static/chunks/750b2726a69f361bcb8ab59f8396713b1d057f97.eb739be10f1a321b366c.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-970c9d204f95e252b248.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/%5Bslug%5D-dbdb6dab1991e2a52bd5.js" as="script"/><style id="__jsx-2257550242">.SiteTitle.jsx-2257550242{font-size:2rem;margin:1rem 0;}</style><style id="__jsx-1424798431">.Tags.jsx-1424798431{padding:0;}.item.jsx-1424798431{display:inline;margin:0 0.2em;}.link.jsx-1424798431{color:var(--color-text-secondary);}</style><style id="__jsx-2638938446">.PostPager.jsx-2638938446{display:table;max-width:var(--width-content);margin:2rem auto;}.item.jsx-2638938446{box-sizing:border-box;display:table-cell;width:33.3%;padding:0.5rem;text-align:center;vertical-align:middle;}.home.jsx-2638938446{border-left:1px solid #6c6c6c;border-right:1px solid #6c6c6c;}</style><style id="__jsx-2000003725">.Posts.jsx-2000003725{list-style:none;padding:0;}.Posts-item.jsx-2000003725{padding:1rem 1.5rem;margin:1rem 0;border:1px solid #bbb;}</style><style id="__jsx-101915585">.Footer.jsx-101915585{text-align:center;}</style><style id="__jsx-2377730788">main{display:block;}header+main{padding-top:0;}header:last-child{padding-bottom:0;}pre{overflow:auto;max-width:none;padding:0.5rem 2rem;background:#272822;}pre code,pre samp{display:inline;padding:0;}.token.operator,.token.entity,.token.url,.language-css .token.string,.style .token.string{background:transparent;}@media (prefers-color-scheme:dark){:root{--color:#0097fc;--color-accent:#0097fc4f;--color-bg:#333;--color-bg-secondary:#555;--color-secondary:#e20de9;--color-secondary-accent:#e20de94f;--color-shadow:#bbbbbb20;--color-text:#f7f7f7;--color-text-secondary:#aaa;}}</style></head><body><div id="__next"><header><div class="jsx-2257550242 SiteTitle"><a class="jsx-2257550242" href="/">Tech SANDBOX</a></div><p>技術ブログ改め、Qiitaの下書き</p></header><div><article><header><time dateTime="2018-12-20T14:58:37.388Z">2018-12-20</time><h1>Rust + wasm-bindgen + WebWorkerの環境構築</h1><ul class="jsx-1424798431 Tags"><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/Rust/">#<!-- -->Rust</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/wasm-bindgen/">#<!-- -->wasm-bindgen</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/TypeScript/">#<!-- -->TypeScript</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/parcel/">#<!-- -->parcel</a></li></ul></header><main><div><p><a href="https://qiita.com/advent-calendar/2018/wasm">WebAssembly Advent Calendar 2018</a>の20日目の記事。
※ 2019/4/20: 修正</p><h2 id="tldr">TL;DR</h2><p>parcelのparcel-plugin-wasm.rsプラグインを使用しよう！</p><p>サンプルリポジトリはこちら
<a href="https://github.com/iMasanari/wasm-bindgen-with-worker">iMasanari/wasm-bindgen-with-worker</a></p><h2 id="やりたいこと">やりたいこと</h2><p>時間のかかる処理をWebAssemblyで高速に行いたい。そのためには、下記の条件が必要になる。</p><ul><li>引数や戻り値をJSON形式でやりとりできること</li><li>非同期処理であること</li></ul><p>今回は、Rustでwasm-bindgenを使用し、WebWorker内で動かす環境を作っていく。</p><h2 id="1度、webpackで構築するも">1度、WebPackで構築するも……</h2><p>まずは、<a href="https://www.mizdra.net/entry/2018/10/17/080000">WebAssemblyを使って乱数調整ツールをWebに移植した話</a>を元に、WebPackで構築した。しかし、3つの気になる点が出てきた。</p><ul><li>Worker用のエントリーファイルをもう1つ用意しなければならない<ul><li><a href="https://github.com/webpack/webpack/issues/7647">Cannot import wasm in web workers #7647</a></li></ul></li><li>中間ファイル生成（Rust→wasm）のせいで、ビルドタスクが煩雑になる</li><li>ライブリロード<ul><li>ワンテンポ遅いタイミングでページ全体のリロードがされる</li><li>リロードの読み込み時間も長い</li></ul></li></ul><p>エントリーファイルの問題は、WebWorkerのファイル名にハッシュ（<code>worker.2290ab9e.js</code>の<code>2290ab9e</code>部分）が付けられないことである。今回はスクリプトがView、WebWorker、WASMの3ファイルに分かれるので、キャッシュ対策のためにも必要度は高い。</p><h2 id="parcelでの環境構築">parcelでの環境構築</h2><p>Webpackで環境を作って数日後、ふと別のモジュールバンドラを使用すればよいのではと思い、parcelで試してみた。すると、上記のエントリーファイル問題、中間ファイル問題を解決することができた。
ライブリロードの件は一応差分更新を試みてくれるが、Rustの更新内容は反映されなかった。ただ、普段ライブリロードは使わず、またワンテンポ遅れの全リロードでないためそこまで問題は感じていない。</p><p>なぜ最初にparcelで試さなかったのかというと、情報がWebpackのものしかなかったからだ。なので今回、parcelでWebWorker + WebAssemblyを扱う方法を共有したい。（といっても、parcelがゼロコンフィグなモジュールバンドラのため、そこまで凝ったことはしていない）</p><h2 id="各種インストール">各種インストール</h2><p>Node.jsやRustはインストール済みとする。</p><p>parcelのインストール</p><p><del>parcel-plugin-wasm.rs v1.2.7はparcel-bundler v1.11.0に対応していないのかビルドエラーになったため、バージョンを指定してインストールしている。</del> ※最新バージョンで治っていることを確認。</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers="">$ <span class="token function">npm</span> <span class="token function">install</span> -D parcel-bundler parcel-plugin-wasm.rs
</code></pre><p>parcel-plugin-wasm.rsはRustをwasm-packでコンパイルするためのparcelのプラグイン。wasm-packのインストールがまだの場合はインストールする。</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers="">$ cargo <span class="token function">install</span> wasm-pack
</code></pre><p>個人的にいつもTypeScriptを使うので、それ関連のインストール。
<a href="https://www.npmjs.com/package/@types/webassembly-js-api">@types/webassembly-js-api</a>は、WebAssemblyの型定義。</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers="">$ <span class="token function">npm</span> <span class="token function">install</span> -D typescript @types/webassembly-js-api
</code></pre><h2 id="フォルダ構成と設定ファイル">フォルダ構成と設定ファイル</h2><h3 id="フォルダ構成（srcフォルダ）">フォルダ構成（srcフォルダ）</h3><p>各種フォルダとエントリーポイントのHTMLという構成で、個人的にすごくきれいな配置だと思う。
ちなみにこの出力をするためにMacへTreeコマンドを入れた。</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers="">$ tree src
src
├── app
│   └── index.ts
├── wasm
│   ├── lib.rs
│   └── lib.rs.d.ts
├── worker
│   └── index.ts
└── index.html
</code></pre><h3 id="各種設定ファイル（必要最低限の箇所のみ）">各種設定ファイル（必要最低限の箇所のみ）</h3><pre><code class="language-json" data-language="json" data-highlighted-line-numbers=""><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"parcel src/index.html"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"parcel build src/index.html"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"@types/webassembly-js-api"</span><span class="token operator">:</span> <span class="token string">"0.0.3"</span><span class="token punctuation">,</span>
    <span class="token property">"parcel-bundler"</span><span class="token operator">:</span> <span class="token string">"^1.12.3"</span><span class="token punctuation">,</span>
    <span class="token property">"parcel-plugin-wasm.rs"</span><span class="token operator">:</span> <span class="token string">"^1.2.8"</span><span class="token punctuation">,</span>
    <span class="token property">"typescript"</span><span class="token operator">:</span> <span class="token string">"^3.4.2"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"browserslist"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"last 2 chrome versions"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><pre><code class="language-toml" data-language="toml" data-highlighted-line-numbers=""><span class="token comment"># Cargo.toml</span>
<span class="token punctuation">[</span><span class="token table class-name">package</span><span class="token punctuation">]</span>
<span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"wasm"</span>
<span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"0.1.0"</span>

<span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">wasm-bindgen</span> <span class="token punctuation">=</span> <span class="token string">"^0.2"</span>

<span class="token punctuation">[</span><span class="token table class-name">lib</span><span class="token punctuation">]</span>
<span class="token key property">crate-type</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"cdylib"</span><span class="token punctuation">]</span>
<span class="token key property">path</span> <span class="token punctuation">=</span> <span class="token string">"./src/wasm/lib.rs"</span>
</code></pre><pre><code class="language-json" data-language="json" data-highlighted-line-numbers=""><span class="token comment">// tsconfig.json</span>
<span class="token punctuation">{</span>
  <span class="token property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"target"</span><span class="token operator">:</span> <span class="token string">"es2015"</span><span class="token punctuation">,</span>
    <span class="token property">"lib"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"es2015"</span><span class="token punctuation">,</span>
      <span class="token string">"dom"</span><span class="token punctuation">,</span>
      <span class="token string">"webworker"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"strict"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"esModuleInterop"</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>WebAssembly未対応のIEを切り捨て、TypeScriptのコンパイルはes2015で行っている。parcelのbabel側でes5に変換されないよう、<code>package.json</code>では<code>browserslist</code>の設定を行う。</p><h2 id="各ファイル">各ファイル</h2><p>全部書くのも面倒なので、各ファイルのインポート部分だけ書いていく。
書き足している場所もあるが、全体はサンプルリポジトリを参照。
<a href="https://github.com/iMasanari/wasm-bindgen-with-worker">iMasanari/wasm-bindgen-with-worker</a></p><pre><code class="language-markup" data-language="markup" data-highlighted-line-numbers=""><span class="token comment">&lt;!-- src/index.html --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app/index.ts<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
</code></pre><pre><code class="language-typescript" data-language="typescript" data-highlighted-line-numbers=""><span class="token comment">// src/app/index.ts</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'../worker/index.ts'</span><span class="token punctuation">)</span>
</code></pre><pre><code class="language-typescript" data-language="typescript" data-highlighted-line-numbers=""><span class="token comment">// src/worker/index.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> wasm <span class="token keyword">from</span> <span class="token string">'../wasm/lib.rs'</span>

<span class="token comment">// WebAssemblyの実行</span>
wasm<span class="token punctuation">.</span><span class="token function">some_function</span><span class="token punctuation">(</span><span class="token string">'WebAssembly'</span><span class="token punctuation">)</span>
</code></pre><p>あとは、Rustの関数を作るだけ。
現在のWebAssemblyは数値しかやりとりができないが、wasm-bindgenを使うことで文字列やJSONもやりとりができるようになる。</p><pre><code class="language-rust" data-language="rust" data-highlighted-line-numbers=""><span class="token comment">// src/wasm/lib.rs</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">wasm_bindgen</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">wasm_bindgen<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[wasm_bindgen]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">some_function</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"Hello, {}!"</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>ビルドも下記コマンドだけでOK。
初回だけ、Rustのビルドに時間がかかる。</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers=""><span class="token comment"># デバッグ用ビルド + サーバー</span>
$ <span class="token function">npm</span> run dev
</code></pre><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers=""><span class="token comment"># プロダクションビルド</span>
$ <span class="token function">npm</span> run build
</code></pre><p>出力結果はこんな感じ。
なぜか<code>lib.rs</code>まで出力されているが、ちゃんとハッシュが付いているのが確認できる。</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers="">$ tree dist
dist
├── app.68414551.js
├── index.html
├── lib.3d22fd5b.rs
├── wasm_bg.ead9fc9c.wasm
└── worker.135e8d27.js
</code></pre><h2 id="webpackとの違い">Webpackとの違い</h2><h3 id="rustからのjavascriptコード呼び出しパス">RustからのJavaScriptコード呼び出しパス</h3><p>Webpackでは、pkgフォルダ内のファイルをインポートするため、相対パスの基準は<code>pkg/</code>である。
parcel(parcel-plugin-wasm.rs)では、<code>node_modules/parcel-plugin-wasm.rs/</code>が基準である。parcelの絶対パス（<code>/*</code>）を使えば、エントリーファイルの場所（今回は<code>src/</code>）が基準になる。</p><pre><code class="language-rust" data-language="rust" data-highlighted-line-numbers=""><span class="token comment">// src/wasm/lib.rs</span>
<span class="token attribute attr-name">#[wasm_bindgen(module = <span class="token string">"/worker/wasm-util"</span>)]</span>
<span class="token keyword">extern</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">console_log</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="webworker側でのrustインポート">WebWorker側でのRustインポート</h3><p>Webpackでは、WASMをインポートするまでに必ずDynamic importを挟む必要がある。
parcelではその必要がなく、直接importする。（そもそもWebWroker内でのDynamic importがサポートされていない？）</p><p>つまり、parcelではWASMロード中の<code>postMessage</code>を取りこぼしてしまう可能性がある。
そのため<a href="https://github.com/iMasanari/wasm-bindgen-with-worker">サンプル</a>では、<a href="https://github.com/iMasanari/wasm-bindgen-with-worker/blob/master/src/app/wasmWorker.ts#L24">ロードを待ってからメッセージを送る</a>ようにしている。</p><h2 id="まとめ">まとめ</h2><p>parcelを使うことで、簡単にWebAssemblyが始められる。</p><p>ちなみにRustは、C言語並みの処理スピードを持ちながらモダンな文法と強力なコンパイル時チェックを備えている言語でおすすめ！　所有権、借用、ライフタイム？　学習コストが高い？　知らんな。一緒に<a href="https://doc.rust-jp.rs/the-rust-programming-language-ja/1.6/book/references-and-borrowing.html#%E6%A6%82%E8%AB%96">借用チェッカと戦おうぜ！</a> by Rust初心者</p></div></main></article><div class="jsx-2638938446 PostPager"><div class="jsx-2638938446 item"><a class="jsx-2638938446" href="/blog/difference-between-jsx-and-html/">HTMLでは使えないJSX独自の書き方</a></div><div class="jsx-2638938446 item home"><a class="jsx-2638938446" href="/">HOME</a></div><div class="jsx-2638938446 item"><a class="jsx-2638938446" href="/blog/use-parcel/">ブログ開発をParcelに変更した</a></div></div><aside><header><h1>同じタグを含む記事</h1><ul class="jsx-1424798431 Tags"><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/Rust/">#<!-- -->Rust</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/wasm-bindgen/">#<!-- -->wasm-bindgen</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/TypeScript/">#<!-- -->TypeScript</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/parcel/">#<!-- -->parcel</a></li></ul></header><main><ul class="jsx-2000003725 Posts"><li class="jsx-2000003725 Posts-item"><article class="jsx-2000003725"><header><time dateTime="2019-04-26T13:55:56.097Z">2019-04-26</time><h1><a href="/blog/use-parcel/">ブログ開発をParcelに変更した</a></h1><ul class="jsx-1424798431 Tags"><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/parcel/">#<!-- -->parcel</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/blog/">#<!-- -->blog</a></li></ul></header></article></li><li class="jsx-2000003725 Posts-item"><article class="jsx-2000003725"><header><time dateTime="2018-07-13T12:47:36.148Z">2018-07-13</time><h1><a href="/blog/remove-object-key/">【ES.next】Objectから任意のキーを削除した新しいObjectを作成する</a></h1><ul class="jsx-1424798431 Tags"><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/JavaScript/">#<!-- -->JavaScript</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/Babel/">#<!-- -->Babel</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/TypeScript/">#<!-- -->TypeScript</a></li></ul></header></article></li><li class="jsx-2000003725 Posts-item"><article class="jsx-2000003725"><header><time dateTime="2018-07-03T11:47:13.910Z">2018-07-03</time><h1><a href="/blog/webpacks-rules-in-static-config-js/">React StaticでTypeScriptを使用した時のエラー対処法</a></h1><ul class="jsx-1424798431 Tags"><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/ReactStatic/">#<!-- -->ReactStatic</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/TypeScript/">#<!-- -->TypeScript</a></li><li class="jsx-1424798431 item"><a class="jsx-1424798431 link" href="/tags/webpack/">#<!-- -->webpack</a></li></ul></header></article></li></ul></main></aside></div><footer class="jsx-101915585 Footer"><p class="jsx-101915585">Author: <a href="https://github.com/iMasanari" class="jsx-101915585">iMasanari</a></p><small class="jsx-101915585"><a href="https://github.com/iMasanari/imasanari.github.io/" class="jsx-101915585">Show on GitHub</a></small></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Rust + wasm-bindgen + WebWorkerの環境構築","description":"WebAssembly Advent Calendar 2018の20日目の記事。","slug":"wasm-bindgen-with-worker","tags":["Rust","wasm-bindgen","TypeScript","parcel"],"date":"2018-12-20T14:58:37.388Z","update":"2019-04-20T13:15:27.878Z","body":"\u003cp\u003e\u003ca href=\"https://qiita.com/advent-calendar/2018/wasm\"\u003eWebAssembly Advent Calendar 2018\u003c/a\u003eの20日目の記事。\n※ 2019/4/20: 修正\u003c/p\u003e\u003ch2 id=\"tldr\"\u003eTL;DR\u003c/h2\u003e\u003cp\u003eparcelのparcel-plugin-wasm.rsプラグインを使用しよう！\u003c/p\u003e\u003cp\u003eサンプルリポジトリはこちら\n\u003ca href=\"https://github.com/iMasanari/wasm-bindgen-with-worker\"\u003eiMasanari/wasm-bindgen-with-worker\u003c/a\u003e\u003c/p\u003e\u003ch2 id=\"やりたいこと\"\u003eやりたいこと\u003c/h2\u003e\u003cp\u003e時間のかかる処理をWebAssemblyで高速に行いたい。そのためには、下記の条件が必要になる。\u003c/p\u003e\u003cul\u003e\u003cli\u003e引数や戻り値をJSON形式でやりとりできること\u003c/li\u003e\u003cli\u003e非同期処理であること\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e今回は、Rustでwasm-bindgenを使用し、WebWorker内で動かす環境を作っていく。\u003c/p\u003e\u003ch2 id=\"1度、webpackで構築するも\"\u003e1度、WebPackで構築するも……\u003c/h2\u003e\u003cp\u003eまずは、\u003ca href=\"https://www.mizdra.net/entry/2018/10/17/080000\"\u003eWebAssemblyを使って乱数調整ツールをWebに移植した話\u003c/a\u003eを元に、WebPackで構築した。しかし、3つの気になる点が出てきた。\u003c/p\u003e\u003cul\u003e\u003cli\u003eWorker用のエントリーファイルをもう1つ用意しなければならない\u003cul\u003e\u003cli\u003e\u003ca href=\"https://github.com/webpack/webpack/issues/7647\"\u003eCannot import wasm in web workers #7647\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003c/li\u003e\u003cli\u003e中間ファイル生成（Rust→wasm）のせいで、ビルドタスクが煩雑になる\u003c/li\u003e\u003cli\u003eライブリロード\u003cul\u003e\u003cli\u003eワンテンポ遅いタイミングでページ全体のリロードがされる\u003c/li\u003e\u003cli\u003eリロードの読み込み時間も長い\u003c/li\u003e\u003c/ul\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eエントリーファイルの問題は、WebWorkerのファイル名にハッシュ（\u003ccode\u003eworker.2290ab9e.js\u003c/code\u003eの\u003ccode\u003e2290ab9e\u003c/code\u003e部分）が付けられないことである。今回はスクリプトがView、WebWorker、WASMの3ファイルに分かれるので、キャッシュ対策のためにも必要度は高い。\u003c/p\u003e\u003ch2 id=\"parcelでの環境構築\"\u003eparcelでの環境構築\u003c/h2\u003e\u003cp\u003eWebpackで環境を作って数日後、ふと別のモジュールバンドラを使用すればよいのではと思い、parcelで試してみた。すると、上記のエントリーファイル問題、中間ファイル問題を解決することができた。\nライブリロードの件は一応差分更新を試みてくれるが、Rustの更新内容は反映されなかった。ただ、普段ライブリロードは使わず、またワンテンポ遅れの全リロードでないためそこまで問題は感じていない。\u003c/p\u003e\u003cp\u003eなぜ最初にparcelで試さなかったのかというと、情報がWebpackのものしかなかったからだ。なので今回、parcelでWebWorker + WebAssemblyを扱う方法を共有したい。（といっても、parcelがゼロコンフィグなモジュールバンドラのため、そこまで凝ったことはしていない）\u003c/p\u003e\u003ch2 id=\"各種インストール\"\u003e各種インストール\u003c/h2\u003e\u003cp\u003eNode.jsやRustはインストール済みとする。\u003c/p\u003e\u003cp\u003eparcelのインストール\u003c/p\u003e\u003cp\u003e\u003cdel\u003eparcel-plugin-wasm.rs v1.2.7はparcel-bundler v1.11.0に対応していないのかビルドエラーになったため、バージョンを指定してインストールしている。\u003c/del\u003e ※最新バージョンで治っていることを確認。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"language-bash\" data-language=\"bash\" data-highlighted-line-numbers=\"\"\u003e$ \u003cspan class=\"token function\"\u003enpm\u003c/span\u003e \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e -D parcel-bundler parcel-plugin-wasm.rs\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eparcel-plugin-wasm.rsはRustをwasm-packでコンパイルするためのparcelのプラグイン。wasm-packのインストールがまだの場合はインストールする。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"language-bash\" data-language=\"bash\" data-highlighted-line-numbers=\"\"\u003e$ cargo \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e wasm-pack\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e個人的にいつもTypeScriptを使うので、それ関連のインストール。\n\u003ca href=\"https://www.npmjs.com/package/@types/webassembly-js-api\"\u003e@types/webassembly-js-api\u003c/a\u003eは、WebAssemblyの型定義。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"language-bash\" data-language=\"bash\" data-highlighted-line-numbers=\"\"\u003e$ \u003cspan class=\"token function\"\u003enpm\u003c/span\u003e \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e -D typescript @types/webassembly-js-api\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"フォルダ構成と設定ファイル\"\u003eフォルダ構成と設定ファイル\u003c/h2\u003e\u003ch3 id=\"フォルダ構成（srcフォルダ）\"\u003eフォルダ構成（srcフォルダ）\u003c/h3\u003e\u003cp\u003e各種フォルダとエントリーポイントのHTMLという構成で、個人的にすごくきれいな配置だと思う。\nちなみにこの出力をするためにMacへTreeコマンドを入れた。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"language-bash\" data-language=\"bash\" data-highlighted-line-numbers=\"\"\u003e$ tree src\nsrc\n├── app\n│   └── index.ts\n├── wasm\n│   ├── lib.rs\n│   └── lib.rs.d.ts\n├── worker\n│   └── index.ts\n└── index.html\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"各種設定ファイル（必要最低限の箇所のみ）\"\u003e各種設定ファイル（必要最低限の箇所のみ）\u003c/h3\u003e\u003cpre\u003e\u003ccode class=\"language-json\" data-language=\"json\" data-highlighted-line-numbers=\"\"\u003e\u003cspan class=\"token comment\"\u003e// package.json\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"scripts\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"dev\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"parcel src/index.html\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"build\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"parcel build src/index.html\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"devDependencies\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"@types/webassembly-js-api\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"0.0.3\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"parcel-bundler\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"^1.12.3\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"parcel-plugin-wasm.rs\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"^1.2.8\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"typescript\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"^3.4.2\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"browserslist\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"last 2 chrome versions\"\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cpre\u003e\u003ccode class=\"language-toml\" data-language=\"toml\" data-highlighted-line-numbers=\"\"\u003e\u003cspan class=\"token comment\"\u003e# Cargo.toml\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token table class-name\"\u003epackage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token key property\"\u003ename\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"wasm\"\u003c/span\u003e\n\u003cspan class=\"token key property\"\u003eversion\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"0.1.0\"\u003c/span\u003e\n\n\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token table class-name\"\u003edependencies\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token key property\"\u003ewasm-bindgen\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"^0.2\"\u003c/span\u003e\n\n\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token table class-name\"\u003elib\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token key property\"\u003ecrate-type\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"cdylib\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"token key property\"\u003epath\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"./src/wasm/lib.rs\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cpre\u003e\u003ccode class=\"language-json\" data-language=\"json\" data-highlighted-line-numbers=\"\"\u003e\u003cspan class=\"token comment\"\u003e// tsconfig.json\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"compilerOptions\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"target\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"es2015\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"lib\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"token string\"\u003e\"es2015\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token string\"\u003e\"dom\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token string\"\u003e\"webworker\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"strict\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"esModuleInterop\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eWebAssembly未対応のIEを切り捨て、TypeScriptのコンパイルはes2015で行っている。parcelのbabel側でes5に変換されないよう、\u003ccode\u003epackage.json\u003c/code\u003eでは\u003ccode\u003ebrowserslist\u003c/code\u003eの設定を行う。\u003c/p\u003e\u003ch2 id=\"各ファイル\"\u003e各ファイル\u003c/h2\u003e\u003cp\u003e全部書くのも面倒なので、各ファイルのインポート部分だけ書いていく。\n書き足している場所もあるが、全体はサンプルリポジトリを参照。\n\u003ca href=\"https://github.com/iMasanari/wasm-bindgen-with-worker\"\u003eiMasanari/wasm-bindgen-with-worker\u003c/a\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"language-markup\" data-language=\"markup\" data-highlighted-line-numbers=\"\"\u003e\u003cspan class=\"token comment\"\u003e\u0026lt;!-- src/index.html --\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003escript\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003esrc\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003eapp/index.ts\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token script\"\u003e\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003escript\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cpre\u003e\u003ccode class=\"language-typescript\" data-language=\"typescript\" data-highlighted-line-numbers=\"\"\u003e\u003cspan class=\"token comment\"\u003e// src/app/index.ts\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e worker \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWorker\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'../worker/index.ts'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cpre\u003e\u003ccode class=\"language-typescript\" data-language=\"typescript\" data-highlighted-line-numbers=\"\"\u003e\u003cspan class=\"token comment\"\u003e// src/worker/index.ts\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e wasm \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"token string\"\u003e'../wasm/lib.rs'\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// WebAssemblyの実行\u003c/span\u003e\nwasm\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esome_function\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'WebAssembly'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eあとは、Rustの関数を作るだけ。\n現在のWebAssemblyは数値しかやりとりができないが、wasm-bindgenを使うことで文字列やJSONもやりとりができるようになる。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"language-rust\" data-language=\"rust\" data-highlighted-line-numbers=\"\"\u003e\u003cspan class=\"token comment\"\u003e// src/wasm/lib.rs\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eextern\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ecrate\u003c/span\u003e \u003cspan class=\"token module-declaration namespace\"\u003ewasm_bindgen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token namespace\"\u003ewasm_bindgen\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003eprelude\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token attribute attr-name\"\u003e#[wasm_bindgen]\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003epub\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003esome_function\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003einput\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003estr\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e-\u003e\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eString\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token macro property\"\u003eformat!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Hello, {}!\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e input\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eビルドも下記コマンドだけでOK。\n初回だけ、Rustのビルドに時間がかかる。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"language-bash\" data-language=\"bash\" data-highlighted-line-numbers=\"\"\u003e\u003cspan class=\"token comment\"\u003e# デバッグ用ビルド + サーバー\u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003enpm\u003c/span\u003e run dev\n\u003c/code\u003e\u003c/pre\u003e\u003cpre\u003e\u003ccode class=\"language-bash\" data-language=\"bash\" data-highlighted-line-numbers=\"\"\u003e\u003cspan class=\"token comment\"\u003e# プロダクションビルド\u003c/span\u003e\n$ \u003cspan class=\"token function\"\u003enpm\u003c/span\u003e run build\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e出力結果はこんな感じ。\nなぜか\u003ccode\u003elib.rs\u003c/code\u003eまで出力されているが、ちゃんとハッシュが付いているのが確認できる。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"language-bash\" data-language=\"bash\" data-highlighted-line-numbers=\"\"\u003e$ tree dist\ndist\n├── app.68414551.js\n├── index.html\n├── lib.3d22fd5b.rs\n├── wasm_bg.ead9fc9c.wasm\n└── worker.135e8d27.js\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"webpackとの違い\"\u003eWebpackとの違い\u003c/h2\u003e\u003ch3 id=\"rustからのjavascriptコード呼び出しパス\"\u003eRustからのJavaScriptコード呼び出しパス\u003c/h3\u003e\u003cp\u003eWebpackでは、pkgフォルダ内のファイルをインポートするため、相対パスの基準は\u003ccode\u003epkg/\u003c/code\u003eである。\nparcel(parcel-plugin-wasm.rs)では、\u003ccode\u003enode_modules/parcel-plugin-wasm.rs/\u003c/code\u003eが基準である。parcelの絶対パス（\u003ccode\u003e/*\u003c/code\u003e）を使えば、エントリーファイルの場所（今回は\u003ccode\u003esrc/\u003c/code\u003e）が基準になる。\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"language-rust\" data-language=\"rust\" data-highlighted-line-numbers=\"\"\u003e\u003cspan class=\"token comment\"\u003e// src/wasm/lib.rs\u003c/span\u003e\n\u003cspan class=\"token attribute attr-name\"\u003e#[wasm_bindgen(module = \u003cspan class=\"token string\"\u003e\"/worker/wasm-util\"\u003c/span\u003e)]\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eextern\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efn\u003c/span\u003e \u003cspan class=\"token function-definition function\"\u003econsole_log\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003es\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"token keyword\"\u003estr\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"webworker側でのrustインポート\"\u003eWebWorker側でのRustインポート\u003c/h3\u003e\u003cp\u003eWebpackでは、WASMをインポートするまでに必ずDynamic importを挟む必要がある。\nparcelではその必要がなく、直接importする。（そもそもWebWroker内でのDynamic importがサポートされていない？）\u003c/p\u003e\u003cp\u003eつまり、parcelではWASMロード中の\u003ccode\u003epostMessage\u003c/code\u003eを取りこぼしてしまう可能性がある。\nそのため\u003ca href=\"https://github.com/iMasanari/wasm-bindgen-with-worker\"\u003eサンプル\u003c/a\u003eでは、\u003ca href=\"https://github.com/iMasanari/wasm-bindgen-with-worker/blob/master/src/app/wasmWorker.ts#L24\"\u003eロードを待ってからメッセージを送る\u003c/a\u003eようにしている。\u003c/p\u003e\u003ch2 id=\"まとめ\"\u003eまとめ\u003c/h2\u003e\u003cp\u003eparcelを使うことで、簡単にWebAssemblyが始められる。\u003c/p\u003e\u003cp\u003eちなみにRustは、C言語並みの処理スピードを持ちながらモダンな文法と強力なコンパイル時チェックを備えている言語でおすすめ！　所有権、借用、ライフタイム？　学習コストが高い？　知らんな。一緒に\u003ca href=\"https://doc.rust-jp.rs/the-rust-programming-language-ja/1.6/book/references-and-borrowing.html#%E6%A6%82%E8%AB%96\"\u003e借用チェッカと戦おうぜ！\u003c/a\u003e by Rust初心者\u003c/p\u003e"},"next":{"title":"ブログ開発をParcelに変更した","description":"前回の記事でparcelを使用して便利だったので、このブログのモジュールバンドラをparcelに変更した。決め手は、Tree Shakingがサポートされていたから。","slug":"use-parcel","tags":["parcel","blog"],"date":"2019-04-26T13:55:56.097Z"},"prev":{"title":"HTMLでは使えないJSX独自の書き方","description":"HTMLとReact JSXの書き方の違いでハマったポイントをまとめた。","slug":"difference-between-jsx-and-html","tags":["React"],"date":"2018-08-13T14:57:58.277Z"},"sameTags":[{"title":"ブログ開発をParcelに変更した","description":"前回の記事でparcelを使用して便利だったので、このブログのモジュールバンドラをparcelに変更した。決め手は、Tree Shakingがサポートされていたから。","slug":"use-parcel","tags":["parcel","blog"],"date":"2019-04-26T13:55:56.097Z"},{"title":"【ES.next】Objectから任意のキーを削除した新しいObjectを作成する","description":"ブログを作る前、Qiitaに投稿しようと書いていたけど途中でやめ、最近まで忘れていた記事です。Qiitaでもいいけど、せっかくだからこっちに置いておきます。","slug":"remove-object-key","tags":["JavaScript","Babel","TypeScript"],"date":"2018-07-13T12:47:36.148Z"},{"title":"React StaticでTypeScriptを使用した時のエラー対処法","description":"static.config.jsのwebpack設定を変更することで起こるエラーの対処法。","slug":"webpacks-rules-in-static-config-js","tags":["ReactStatic","TypeScript","webpack"],"date":"2018-07-03T11:47:13.910Z"}]},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"wasm-bindgen-with-worker"},"buildId":"q8QMAlGHSrOgH_qo9W2MU","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-a5b86a38e61b63f3b3a9.js"></script><script src="/_next/static/chunks/main-f01cf1dcca173d7f43b1.js" async=""></script><script src="/_next/static/chunks/webpack-ccf5ab034a524403276a.js" async=""></script><script src="/_next/static/chunks/framework.6c6c2144b5674c37af03.js" async=""></script><script src="/_next/static/chunks/commons.65195c3ca934dc067d4c.js" async=""></script><script src="/_next/static/chunks/750b2726a69f361bcb8ab59f8396713b1d057f97.eb739be10f1a321b366c.js" async=""></script><script src="/_next/static/chunks/pages/_app-970c9d204f95e252b248.js" async=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-dbdb6dab1991e2a52bd5.js" async=""></script><script src="/_next/static/q8QMAlGHSrOgH_qo9W2MU/_buildManifest.js" async=""></script><script src="/_next/static/q8QMAlGHSrOgH_qo9W2MU/_ssgManifest.js" async=""></script></body></html>