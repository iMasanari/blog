{"pageProps":{"post":{"title":"Rust + wasm-bindgen + WebWorkerの環境構築","description":"WebAssembly Advent Calendar 2018の20日目の記事。","slug":"wasm-bindgen-with-worker","tags":["Rust","wasm-bindgen","TypeScript","parcel"],"date":"2018-12-20T14:58:37.388Z","update":"2019-04-20T13:15:27.878Z","image":null,"draft":false},"next":{"title":"ブログ開発をParcelに変更した","description":"前回の記事でparcelを使用して便利だったので、このブログのモジュールバンドラをparcelに変更した。決め手は、Tree Shakingがサポートされていたから。","slug":"use-parcel","tags":["parcel","blog"],"date":"2019-04-26T13:55:56.097Z","update":null,"image":null,"draft":false},"prev":{"title":"HTMLでは使えないJSX独自の書き方","description":"HTMLとReact JSXの書き方の違いでハマったポイントをまとめた。","slug":"difference-between-jsx-and-html","tags":["React"],"date":"2018-08-13T14:57:58.277Z","update":null,"image":null,"draft":false},"sameTags":[{"title":"ブログ開発をParcelに変更した","description":"前回の記事でparcelを使用して便利だったので、このブログのモジュールバンドラをparcelに変更した。決め手は、Tree Shakingがサポートされていたから。","slug":"use-parcel","tags":["parcel","blog"],"date":"2019-04-26T13:55:56.097Z","update":null,"image":null,"draft":false},{"title":"【ES.next】Objectから任意のキーを削除した新しいObjectを作成する","description":"ブログを作る前、Qiitaに投稿しようと書いていたけど途中でやめ、最近まで忘れていた記事です。Qiitaでもいいけど、せっかくだからこっちに置いておきます。","slug":"remove-object-key","tags":["JavaScript","Babel","TypeScript"],"date":"2018-07-13T12:47:36.148Z","update":null,"image":null,"draft":false},{"title":"React StaticでTypeScriptを使用した時のエラー対処法","description":"static.config.jsのwebpack設定を変更することで起こるエラーの対処法。","slug":"webpacks-rules-in-static-config-js","tags":["ReactStatic","TypeScript","webpack"],"date":"2018-07-03T11:47:13.910Z","update":null,"image":null,"draft":false}],"content":"<p><a href=\"https://qiita.com/advent-calendar/2018/wasm\">WebAssembly Advent Calendar 2018</a>の20日目の記事。\n※ 2019/4/20: 修正</p>\n<h2>TL;DR</h2>\n<p>parcelのparcel-plugin-wasm.rsプラグインを使用しよう！</p>\n<p>サンプルリポジトリはこちら\n<a href=\"https://github.com/iMasanari/wasm-bindgen-with-worker\">iMasanari/wasm-bindgen-with-worker</a></p>\n<h2>やりたいこと</h2>\n<p>時間のかかる処理をWebAssemblyで高速に行いたい。そのためには、下記の条件が必要になる。</p>\n<ul>\n<li>引数や戻り値をJSON形式でやりとりできること</li>\n<li>非同期処理であること</li>\n</ul>\n<p>今回は、Rustでwasm-bindgenを使用し、WebWorker内で動かす環境を作っていく。</p>\n<h2>1度、WebPackで構築するも……</h2>\n<p>まずは、<a href=\"https://www.mizdra.net/entry/2018/10/17/080000\">WebAssemblyを使って乱数調整ツールをWebに移植した話</a>を元に、WebPackで構築した。しかし、3つの気になる点が出てきた。</p>\n<ul>\n<li>Worker用のエントリーファイルをもう1つ用意しなければならない\n<ul>\n<li><a href=\"https://github.com/webpack/webpack/issues/7647\">Cannot import wasm in web workers #7647</a></li>\n</ul>\n</li>\n<li>中間ファイル生成（Rust→wasm）のせいで、ビルドタスクが煩雑になる</li>\n<li>ライブリロード\n<ul>\n<li>ワンテンポ遅いタイミングでページ全体のリロードがされる</li>\n<li>リロードの読み込み時間も長い</li>\n</ul>\n</li>\n</ul>\n<p>エントリーファイルの問題は、WebWorkerのファイル名にハッシュ（<code>worker.2290ab9e.js</code>の<code>2290ab9e</code>部分）が付けられないことである。今回はスクリプトがView、WebWorker、WASMの3ファイルに分かれるので、キャッシュ対策のためにも必要度は高い。</p>\n<h2>parcelでの環境構築</h2>\n<p>Webpackで環境を作って数日後、ふと別のモジュールバンドラを使用すればよいのではと思い、parcelで試してみた。すると、上記のエントリーファイル問題、中間ファイル問題を解決することができた。\nライブリロードの件は一応差分更新を試みてくれるが、Rustの更新内容は反映されなかった。ただ、普段ライブリロードは使わず、またワンテンポ遅れの全リロードでないためそこまで問題は感じていない。</p>\n<p>なぜ最初にparcelで試さなかったのかというと、情報がWebpackのものしかなかったからだ。なので今回、parcelでWebWorker + WebAssemblyを扱う方法を共有したい。（といっても、parcelがゼロコンフィグなモジュールバンドラのため、そこまで凝ったことはしていない）</p>\n<h2>各種インストール</h2>\n<p>Node.jsやRustはインストール済みとする。</p>\n<p>parcelのインストール</p>\n<p><del>parcel-plugin-wasm.rs v1.2.7はparcel-bundler v1.11.0に対応していないのかビルドエラーになったため、バージョンを指定してインストールしている。</del></p>\n<p>※最新バージョンで治っていることを確認。</p>\n<app-code-wrapper lang=\"bash\" code=\"$ npm install -D parcel-bundler parcel-plugin-wasm.rs\"><pre class=\"shiki dark-plus\" style=\"background-color: #1E1E1E\"><code><span class=\"line\"><span style=\"color: #D4D4D4\">$ </span><span style=\"color: #CE9178\">npm</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">install</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">-D</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">parcel-bundler</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">parcel-plugin-wasm.rs</span></span></code></pre></app-code-wrapper>\n<p>parcel-plugin-wasm.rsはRustをwasm-packでコンパイルするためのparcelのプラグイン。wasm-packのインストールがまだの場合はインストールする。</p>\n<app-code-wrapper lang=\"bash\" code=\"$ cargo install wasm-pack\"><pre class=\"shiki dark-plus\" style=\"background-color: #1E1E1E\"><code><span class=\"line\"><span style=\"color: #D4D4D4\">$ </span><span style=\"color: #CE9178\">cargo</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">install</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">wasm-pack</span></span></code></pre></app-code-wrapper>\n<p>個人的にいつもTypeScriptを使うので、それ関連のインストール。\n<a href=\"https://www.npmjs.com/package/@types/webassembly-js-api\">@types/webassembly-js-api</a>は、WebAssemblyの型定義。</p>\n<app-code-wrapper lang=\"bash\" code=\"$ npm install -D typescript @types/webassembly-js-api\"><pre class=\"shiki dark-plus\" style=\"background-color: #1E1E1E\"><code><span class=\"line\"><span style=\"color: #D4D4D4\">$ </span><span style=\"color: #CE9178\">npm</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">install</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">-D</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">typescript</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">@types/webassembly-js-api</span></span></code></pre></app-code-wrapper>\n<h2>フォルダ構成と設定ファイル</h2>\n<h3>フォルダ構成（srcフォルダ）</h3>\n<p>各種フォルダとエントリーポイントのHTMLという構成で、個人的にすごくきれいな配置だと思う。\nちなみにこの出力をするためにMacへTreeコマンドを入れた。</p>\n<app-code-wrapper lang=\"bash\" code=\"$ tree src\nsrc\n├── app\n│   └── index.ts\n├── wasm\n│   ├── lib.rs\n│   └── lib.rs.d.ts\n├── worker\n│   └── index.ts\n└── index.html\"><pre class=\"shiki dark-plus\" style=\"background-color: #1E1E1E\"><code><span class=\"line\"><span style=\"color: #D4D4D4\">$ </span><span style=\"color: #CE9178\">tree</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">src</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">src</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">├── </span><span style=\"color: #CE9178\">app</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">│   </span><span style=\"color: #CE9178\">└──</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">index.ts</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">├── </span><span style=\"color: #CE9178\">wasm</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">│   </span><span style=\"color: #CE9178\">├──</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">lib.rs</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">│   </span><span style=\"color: #CE9178\">└──</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">lib.rs.d.ts</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">├── </span><span style=\"color: #CE9178\">worker</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">│   </span><span style=\"color: #CE9178\">└──</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">index.ts</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">└── </span><span style=\"color: #CE9178\">index.html</span></span></code></pre></app-code-wrapper>\n<h3>各種設定ファイル（必要最低限の箇所のみ）</h3>\n<app-code-wrapper title=\"package.json\" lang=\"json\" code=\"{\n  &#x22;scripts&#x22;: {\n    &#x22;dev&#x22;: &#x22;parcel src/index.html&#x22;,\n    &#x22;build&#x22;: &#x22;parcel build src/index.html&#x22;,\n  },\n  &#x22;devDependencies&#x22;: {\n    &#x22;@types/webassembly-js-api&#x22;: &#x22;0.0.3&#x22;,\n    &#x22;parcel-bundler&#x22;: &#x22;^1.12.3&#x22;,\n    &#x22;parcel-plugin-wasm.rs&#x22;: &#x22;^1.2.8&#x22;,\n    &#x22;typescript&#x22;: &#x22;^3.4.2&#x22;\n  },\n  &#x22;browserslist&#x22;: [\n    &#x22;last 2 chrome versions&#x22;\n  ]\n}\"><pre class=\"shiki dark-plus\" style=\"background-color: #1E1E1E\"><code><span class=\"line\"><span style=\"color: #D4D4D4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">  </span><span style=\"color: #9CDCFE\">&quot;scripts&quot;</span><span style=\"color: #D4D4D4\">: {</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">    </span><span style=\"color: #9CDCFE\">&quot;dev&quot;</span><span style=\"color: #D4D4D4\">: </span><span style=\"color: #CE9178\">&quot;parcel src/index.html&quot;</span><span style=\"color: #D4D4D4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">    </span><span style=\"color: #9CDCFE\">&quot;build&quot;</span><span style=\"color: #D4D4D4\">: </span><span style=\"color: #CE9178\">&quot;parcel build src/index.html&quot;</span><span style=\"color: #D4D4D4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">  },</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">  </span><span style=\"color: #9CDCFE\">&quot;devDependencies&quot;</span><span style=\"color: #D4D4D4\">: {</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">    </span><span style=\"color: #9CDCFE\">&quot;@types/webassembly-js-api&quot;</span><span style=\"color: #D4D4D4\">: </span><span style=\"color: #CE9178\">&quot;0.0.3&quot;</span><span style=\"color: #D4D4D4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">    </span><span style=\"color: #9CDCFE\">&quot;parcel-bundler&quot;</span><span style=\"color: #D4D4D4\">: </span><span style=\"color: #CE9178\">&quot;^1.12.3&quot;</span><span style=\"color: #D4D4D4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">    </span><span style=\"color: #9CDCFE\">&quot;parcel-plugin-wasm.rs&quot;</span><span style=\"color: #D4D4D4\">: </span><span style=\"color: #CE9178\">&quot;^1.2.8&quot;</span><span style=\"color: #D4D4D4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">    </span><span style=\"color: #9CDCFE\">&quot;typescript&quot;</span><span style=\"color: #D4D4D4\">: </span><span style=\"color: #CE9178\">&quot;^3.4.2&quot;</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">  },</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">  </span><span style=\"color: #9CDCFE\">&quot;browserslist&quot;</span><span style=\"color: #D4D4D4\">: [</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">    </span><span style=\"color: #CE9178\">&quot;last 2 chrome versions&quot;</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">  ]</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">}</span></span></code></pre></app-code-wrapper>\n<app-code-wrapper title=\"Cargo.toml\" lang=\"toml\" code=\"[package]\nname = &#x22;wasm&#x22;\nversion = &#x22;0.1.0&#x22;\n\n[dependencies]\nwasm-bindgen = &#x22;^0.2&#x22;\n\n[lib]\ncrate-type = [&#x22;cdylib&#x22;]\npath = &#x22;./src/wasm/lib.rs&#x22;\"><pre class=\"shiki dark-plus\" style=\"background-color: #1E1E1E\"><code><span class=\"line\"><span style=\"color: #D4D4D4\">[package]</span></span>\n<span class=\"line\"><span style=\"color: #9CDCFE\">name</span><span style=\"color: #D4D4D4\"> = </span><span style=\"color: #CE9178\">&quot;wasm&quot;</span></span>\n<span class=\"line\"><span style=\"color: #9CDCFE\">version</span><span style=\"color: #D4D4D4\"> = </span><span style=\"color: #CE9178\">&quot;0.1.0&quot;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">[dependencies]</span></span>\n<span class=\"line\"><span style=\"color: #9CDCFE\">wasm-bindgen</span><span style=\"color: #D4D4D4\"> = </span><span style=\"color: #CE9178\">&quot;^0.2&quot;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">[lib]</span></span>\n<span class=\"line\"><span style=\"color: #9CDCFE\">crate-type</span><span style=\"color: #D4D4D4\"> = [</span><span style=\"color: #CE9178\">&quot;cdylib&quot;</span><span style=\"color: #D4D4D4\">]</span></span>\n<span class=\"line\"><span style=\"color: #9CDCFE\">path</span><span style=\"color: #D4D4D4\"> = </span><span style=\"color: #CE9178\">&quot;./src/wasm/lib.rs&quot;</span></span></code></pre></app-code-wrapper>\n<app-code-wrapper title=\"tsconfig.json\" lang=\"json\" code=\"{\n  &#x22;compilerOptions&#x22;: {\n    &#x22;target&#x22;: &#x22;es2015&#x22;,\n    &#x22;lib&#x22;: [\n      &#x22;es2015&#x22;,\n      &#x22;dom&#x22;,\n      &#x22;webworker&#x22;\n    ],\n    &#x22;strict&#x22;: true,\n    &#x22;esModuleInterop&#x22;: true\n  }\n}\"><pre class=\"shiki dark-plus\" style=\"background-color: #1E1E1E\"><code><span class=\"line\"><span style=\"color: #D4D4D4\">{</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">  </span><span style=\"color: #9CDCFE\">&quot;compilerOptions&quot;</span><span style=\"color: #D4D4D4\">: {</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">    </span><span style=\"color: #9CDCFE\">&quot;target&quot;</span><span style=\"color: #D4D4D4\">: </span><span style=\"color: #CE9178\">&quot;es2015&quot;</span><span style=\"color: #D4D4D4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">    </span><span style=\"color: #9CDCFE\">&quot;lib&quot;</span><span style=\"color: #D4D4D4\">: [</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">      </span><span style=\"color: #CE9178\">&quot;es2015&quot;</span><span style=\"color: #D4D4D4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">      </span><span style=\"color: #CE9178\">&quot;dom&quot;</span><span style=\"color: #D4D4D4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">      </span><span style=\"color: #CE9178\">&quot;webworker&quot;</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">    ],</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">    </span><span style=\"color: #9CDCFE\">&quot;strict&quot;</span><span style=\"color: #D4D4D4\">: </span><span style=\"color: #569CD6\">true</span><span style=\"color: #D4D4D4\">,</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">    </span><span style=\"color: #9CDCFE\">&quot;esModuleInterop&quot;</span><span style=\"color: #D4D4D4\">: </span><span style=\"color: #569CD6\">true</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">  }</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">}</span></span></code></pre></app-code-wrapper>\n<p>WebAssembly未対応のIEを切り捨て、TypeScriptのコンパイルはes2015で行っている。parcelのbabel側でes5に変換されないよう、<code>package.json</code>では<code>browserslist</code>の設定を行う。</p>\n<h2>各ファイル</h2>\n<p>全部書くのも面倒なので、各ファイルのインポート部分だけ書いていく。\n書き足している場所もあるが、全体はサンプルリポジトリを参照。\n<a href=\"https://github.com/iMasanari/wasm-bindgen-with-worker\">iMasanari/wasm-bindgen-with-worker</a></p>\n<app-code-wrapper title=\"src/index.html\" lang=\"html\" code=\"<script src=&#x22;app/index.ts&#x22;></script>\"><pre class=\"shiki dark-plus\" style=\"background-color: #1E1E1E\"><code><span class=\"line\"><span style=\"color: #808080\">&lt;</span><span style=\"color: #569CD6\">script</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #9CDCFE\">src</span><span style=\"color: #D4D4D4\">=</span><span style=\"color: #CE9178\">&quot;app/index.ts&quot;</span><span style=\"color: #808080\">&gt;&lt;/</span><span style=\"color: #569CD6\">script</span><span style=\"color: #808080\">&gt;</span></span></code></pre></app-code-wrapper>\n<app-code-wrapper title=\"src/app/index.ts\" lang=\"typescript\" code=\"const worker = new Worker(&#x27;../worker/index.ts&#x27;)\"><pre class=\"shiki dark-plus\" style=\"background-color: #1E1E1E\"><code><span class=\"line\"><span style=\"color: #569CD6\">const</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #4FC1FF\">worker</span><span style=\"color: #D4D4D4\"> = </span><span style=\"color: #569CD6\">new</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #DCDCAA\">Worker</span><span style=\"color: #D4D4D4\">(</span><span style=\"color: #CE9178\">&#39;../worker/index.ts&#39;</span><span style=\"color: #D4D4D4\">)</span></span></code></pre></app-code-wrapper>\n<app-code-wrapper title=\"src/worker/index.ts\" lang=\"typescript\" code=\"import * as wasm from &#x27;../wasm/lib.rs&#x27;\n\n// WebAssemblyの実行\nwasm.some_function(&#x27;WebAssembly&#x27;)\"><pre class=\"shiki dark-plus\" style=\"background-color: #1E1E1E\"><code><span class=\"line\"><span style=\"color: #C586C0\">import</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #569CD6\">*</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #C586C0\">as</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #9CDCFE\">wasm</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #C586C0\">from</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">&#39;../wasm/lib.rs&#39;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #6A9955\">// WebAssemblyの実行</span></span>\n<span class=\"line\"><span style=\"color: #9CDCFE\">wasm</span><span style=\"color: #D4D4D4\">.</span><span style=\"color: #DCDCAA\">some_function</span><span style=\"color: #D4D4D4\">(</span><span style=\"color: #CE9178\">&#39;WebAssembly&#39;</span><span style=\"color: #D4D4D4\">)</span></span></code></pre></app-code-wrapper>\n<p>あとは、Rustの関数を作るだけ。\n現在のWebAssemblyは数値しかやりとりができないが、wasm-bindgenを使うことで文字列やJSONもやりとりができるようになる。</p>\n<app-code-wrapper title=\"src/wasm/lib.rs\" lang=\"rust\" code=\"extern crate wasm_bindgen;\nuse wasm_bindgen::prelude::*;\n\n#[wasm_bindgen]\npub fn some_function(input: &#x26;str) -> String {\n    format!(&#x22;Hello, {}!&#x22;, input)\n}\"><pre class=\"shiki dark-plus\" style=\"background-color: #1E1E1E\"><code><span class=\"line\"><span style=\"color: #569CD6\">extern</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #569CD6\">crate</span><span style=\"color: #D4D4D4\"> wasm_bindgen;</span></span>\n<span class=\"line\"><span style=\"color: #569CD6\">use</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #4EC9B0\">wasm_bindgen</span><span style=\"color: #D4D4D4\">::</span><span style=\"color: #4EC9B0\">prelude</span><span style=\"color: #D4D4D4\">::*;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">#[wasm_bindgen]</span></span>\n<span class=\"line\"><span style=\"color: #569CD6\">pub</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #569CD6\">fn</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #DCDCAA\">some_function</span><span style=\"color: #D4D4D4\">(</span><span style=\"color: #9CDCFE\">input</span><span style=\"color: #D4D4D4\">: &amp;</span><span style=\"color: #4EC9B0\">str</span><span style=\"color: #D4D4D4\">) -&gt; </span><span style=\"color: #4EC9B0\">String</span><span style=\"color: #D4D4D4\"> {</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">    </span><span style=\"color: #DCDCAA\">format!</span><span style=\"color: #D4D4D4\">(</span><span style=\"color: #CE9178\">&quot;Hello, {}!&quot;</span><span style=\"color: #D4D4D4\">, </span><span style=\"color: #9CDCFE\">input</span><span style=\"color: #D4D4D4\">)</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">}</span></span></code></pre></app-code-wrapper>\n<p>ビルドも下記コマンドだけでOK。\n初回だけ、Rustのビルドに時間がかかる。</p>\n<app-code-wrapper lang=\"bash\" code=\"# デバッグ用ビルド + サーバー\n$ npm run dev\"><pre class=\"shiki dark-plus\" style=\"background-color: #1E1E1E\"><code><span class=\"line\"><span style=\"color: #6A9955\"># デバッグ用ビルド + サーバー</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">$ </span><span style=\"color: #CE9178\">npm</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">run</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">dev</span></span></code></pre></app-code-wrapper>\n<app-code-wrapper lang=\"bash\" code=\"# プロダクションビルド\n$ npm run build\"><pre class=\"shiki dark-plus\" style=\"background-color: #1E1E1E\"><code><span class=\"line\"><span style=\"color: #6A9955\"># プロダクションビルド</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">$ </span><span style=\"color: #CE9178\">npm</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">run</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">build</span></span></code></pre></app-code-wrapper>\n<p>出力結果はこんな感じ。\nなぜか<code>lib.rs</code>まで出力されているが、ちゃんとハッシュが付いているのが確認できる。</p>\n<app-code-wrapper lang=\"bash\" code=\"$ tree dist\ndist\n├── app.68414551.js\n├── index.html\n├── lib.3d22fd5b.rs\n├── wasm_bg.ead9fc9c.wasm\n└── worker.135e8d27.js\"><pre class=\"shiki dark-plus\" style=\"background-color: #1E1E1E\"><code><span class=\"line\"><span style=\"color: #D4D4D4\">$ </span><span style=\"color: #CE9178\">tree</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #CE9178\">dist</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">dist</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">├── </span><span style=\"color: #CE9178\">app.68414551.js</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">├── </span><span style=\"color: #CE9178\">index.html</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">├── </span><span style=\"color: #CE9178\">lib.3d22fd5b.rs</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">├── </span><span style=\"color: #CE9178\">wasm_bg.ead9fc9c.wasm</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">└── </span><span style=\"color: #CE9178\">worker.135e8d27.js</span></span></code></pre></app-code-wrapper>\n<h2>Webpackとの違い</h2>\n<h3>RustからのJavaScriptコード呼び出しパス</h3>\n<p>Webpackでは、pkgフォルダ内のファイルをインポートするため、相対パスの基準は<code>pkg/</code>である。\nparcel(parcel-plugin-wasm.rs)では、<code>node_modules/parcel-plugin-wasm.rs/</code>が基準である。parcelの絶対パス（<code>/*</code>）を使えば、エントリーファイルの場所（今回は<code>src/</code>）が基準になる。</p>\n<app-code-wrapper title=\"src/wasm/lib.rs\" lang=\"rust\" code=\"#[wasm_bindgen(module = &#x22;/worker/wasm-util&#x22;)]\nextern {\n    fn console_log(s: &#x26;str);\n}\"><pre class=\"shiki dark-plus\" style=\"background-color: #1E1E1E\"><code><span class=\"line\"><span style=\"color: #D4D4D4\">#[wasm_bindgen(module = </span><span style=\"color: #CE9178\">&quot;/worker/wasm-util&quot;</span><span style=\"color: #D4D4D4\">)]</span></span>\n<span class=\"line\"><span style=\"color: #569CD6\">extern</span><span style=\"color: #D4D4D4\"> {</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">    </span><span style=\"color: #569CD6\">fn</span><span style=\"color: #D4D4D4\"> </span><span style=\"color: #DCDCAA\">console_log</span><span style=\"color: #D4D4D4\">(</span><span style=\"color: #9CDCFE\">s</span><span style=\"color: #D4D4D4\">: &amp;</span><span style=\"color: #4EC9B0\">str</span><span style=\"color: #D4D4D4\">);</span></span>\n<span class=\"line\"><span style=\"color: #D4D4D4\">}</span></span></code></pre></app-code-wrapper>\n<h3>WebWorker側でのRustインポート</h3>\n<p>Webpackでは、WASMをインポートするまでに必ずDynamic importを挟む必要がある。\nparcelではその必要がなく、直接importする。（そもそもWebWroker内でのDynamic importがサポートされていない？）</p>\n<p>つまり、parcelではWASMロード中の<code>postMessage</code>を取りこぼしてしまう可能性がある。\nそのため<a href=\"https://github.com/iMasanari/wasm-bindgen-with-worker\">サンプル</a>では、<a href=\"https://github.com/iMasanari/wasm-bindgen-with-worker/blob/master/src/app/wasmWorker.ts#L24\">ロードを待ってからメッセージを送る</a>ようにしている。</p>\n<h2>まとめ</h2>\n<p>parcelを使うことで、簡単にWebAssemblyが始められる。</p>\n<p>ちなみにRustは、C言語並みの処理スピードを持ちながらモダンな文法と強力なコンパイル時チェックを備えている言語でおすすめ！　所有権、借用、ライフタイム？　学習コストが高い？　知らんな。一緒に<a href=\"https://doc.rust-jp.rs/the-rust-programming-language-ja/1.6/book/references-and-borrowing.html#%E6%A6%82%E8%AB%96\">借用チェッカと戦おうぜ！</a> by Rust初心者</p>"},"__N_SSG":true}